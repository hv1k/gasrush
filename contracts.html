<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush â€” Contracts</title>
    <link rel="stylesheet" href="theme.css">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">â›½</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="page-header flex justify-between items-center">
                <div>
                    <h1>Contracts</h1>
                    <p class="text-secondary">Manage vendor contracts and agreements</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="loadData()">ðŸ”„ Refresh</button>
                    <button class="btn btn-primary" onclick="openModal()">+ Add Contract</button>
                </div>
            </div>

            <div id="contractsContainer">
                <div class="empty-state"><div class="empty-state-icon">ðŸ“„</div><h3>Loading...</h3></div>
            </div>
        </main>
    </div>

    <!-- Add Contract Modal -->
    <div class="modal-overlay" id="modalOverlay" style="display:none" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header flex justify-between items-center">
                <h2 class="modal-title">Add Contract</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form onsubmit="saveContract(event)">
                <div class="form-group">
                    <label class="form-label">Vendor Name</label>
                    <input class="form-input" id="fVendor" required>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" id="fStart" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" id="fEnd" required>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Fuel Type</label>
                        <select class="form-select" id="fFuel">
                            <option>Diesel</option>
                            <option>Unleaded</option>
                            <option>Premium</option>
                            <option>Propane</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="fStatus">
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:16px" class="flex justify-between">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Contract</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        const MOCK = [
            { id: 'C-1001', vendor_name: 'PetroCo Fuels', start_date: '2025-01-15', end_date: '2026-01-14', fuel_type: 'Diesel', status: 'active' },
            { id: 'C-1002', vendor_name: 'QuickFill Inc.', start_date: '2024-06-01', end_date: '2025-05-31', fuel_type: 'Unleaded', status: 'expired' },
            { id: 'C-1003', vendor_name: 'GreenEnergy Supply', start_date: '2025-03-01', end_date: '2026-02-28', fuel_type: 'Propane', status: 'pending' },
        ];

        (async () => {
            const user = await GasRush.init({ roles: ['rental', 'vendor', 'admin'] });
            if (!user) return;
            await loadData();
        })();

        async function loadData() {
            try {
                const { data, error } = await GasRush.db().from('contracts').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                render(data && data.length ? data : MOCK);
            } catch(e) {
                console.warn('Contracts table not available, using mock:', e.message);
                render(MOCK);
            }
        }

        function render(rows) {
            const c = document.getElementById('contractsContainer');
            if (!rows.length) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“„</div><h3>No contracts yet</h3></div>'; return; }
            const badge = s => s === 'active' ? 'badge-success' : s === 'expired' ? 'badge-danger' : 'badge-warning';
            let h = '<div class="table-wrapper"><table><thead><tr><th>Contract #</th><th>Vendor</th><th>Start Date</th><th>End Date</th><th>Fuel Type</th><th>Status</th><th></th></tr></thead><tbody>';
            for (const r of rows) {
                h += `<tr>
                    <td><strong>${esc(r.id)}</strong></td>
                    <td>${esc(r.vendor_name||'â€”')}</td>
                    <td>${r.start_date||'â€”'}</td>
                    <td>${r.end_date||'â€”'}</td>
                    <td>${esc(r.fuel_type||'â€”')}</td>
                    <td><span class="badge ${badge(r.status)}">${r.status}</span></td>
                    <td><button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="alert('Details coming soon')">View</button></td>
                </tr>`;
            }
            h += '</tbody></table></div>';
            c.innerHTML = h;
        }

        function openModal() { document.getElementById('modalOverlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

        async function saveContract(e) {
            e.preventDefault();
            const row = {
                vendor_name: document.getElementById('fVendor').value,
                start_date: document.getElementById('fStart').value,
                end_date: document.getElementById('fEnd').value,
                fuel_type: document.getElementById('fFuel').value,
                status: document.getElementById('fStatus').value,
            };
            try {
                const { error } = await GasRush.db().from('contracts').insert([row]);
                if (error) throw error;
            } catch(e) { console.warn('Insert failed:', e.message); }
            closeModal();
            await loadData();
        }

        function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    </script>
</body>
</html>
