<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush â€” Equipment</title>
    <link rel="stylesheet" href="theme.css">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">â›½</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="page-header flex justify-between items-center">
                <div>
                    <h1>Equipment</h1>
                    <p class="text-secondary">Track and manage equipment assets</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="loadData()">ðŸ”„ Refresh</button>
                    <button class="btn btn-primary" onclick="openModal()">+ Add Equipment</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Total Equipment</div><div class="stat-value" id="statTotal">â€”</div></div>
                <div class="stat-card"><div class="stat-label">Active</div><div class="stat-value" id="statActive">â€”</div></div>
                <div class="stat-card"><div class="stat-label">Needs Maintenance</div><div class="stat-value" id="statMaint">â€”</div></div>
            </div>

            <div class="card">
                <div class="card-header"><h2 class="card-title">All Equipment</h2></div>
                <div id="tableContainer">
                    <div class="empty-state"><div class="empty-state-icon">ðŸ”§</div><h3>Loading...</h3></div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalOverlay" style="display:none" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header flex justify-between items-center">
                <h2 class="modal-title">Add Equipment</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form onsubmit="saveEquipment(event)">
                <div class="grid-2">
                    <div class="form-group"><label class="form-label">Name / ID</label><input class="form-input" id="fName" required></div>
                    <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="fType"><option>Fuel Truck</option><option>Pump</option><option>Tank</option><option>Generator</option><option>Other</option></select></div>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label class="form-label">Location</label><input class="form-input" id="fLocation"></div>
                    <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="fStatus"><option value="active">Active</option><option value="maintenance">Maintenance</option><option value="offline">Offline</option></select></div>
                </div>
                <div style="margin-top:16px" class="flex justify-between">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        (async () => {
            const user = await GasRush.init({ roles: ['rental', 'vendor', 'admin'] });
            if (!user) return;
            await loadData();
        })();

        async function loadData() {
            let rows = [];
            try {
                const { data, error } = await GasRush.db().from('equipment').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                rows = data || [];
            } catch(e) { console.warn('Equipment table not available:', e.message); }

            document.getElementById('statTotal').textContent = rows.length;
            document.getElementById('statActive').textContent = rows.filter(r => r.status === 'active').length;
            document.getElementById('statMaint').textContent = rows.filter(r => r.status === 'maintenance').length;
            render(rows);
        }

        function render(rows) {
            const c = document.getElementById('tableContainer');
            if (!rows.length) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ”§</div><h3>No equipment found</h3><p>Add your first piece of equipment above.</p></div>'; return; }
            const badge = s => s === 'active' ? 'badge-success' : s === 'maintenance' ? 'badge-warning' : 'badge-danger';
            let h = '<div class="table-wrapper"><table><thead><tr><th>Name / ID</th><th>Type</th><th>Location</th><th>Status</th><th>Last Service</th></tr></thead><tbody>';
            for (const r of rows) {
                h += `<tr><td><strong>${esc(r.name||r.id)}</strong></td><td>${esc(r.type||'â€”')}</td><td>${esc(r.location||'â€”')}</td><td><span class="badge ${badge(r.status)}">${r.status||'â€”'}</span></td><td>${r.last_service_date||'â€”'}</td></tr>`;
            }
            h += '</tbody></table></div>';
            c.innerHTML = h;
        }

        function openModal() { document.getElementById('modalOverlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

        async function saveEquipment(e) {
            e.preventDefault();
            const row = { name: document.getElementById('fName').value, type: document.getElementById('fType').value, location: document.getElementById('fLocation').value, status: document.getElementById('fStatus').value };
            try { const { error } = await GasRush.db().from('equipment').insert([row]); if (error) throw error; } catch(e) { console.warn('Insert failed:', e.message); }
            closeModal(); await loadData();
        }

        function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    </script>
</body>
</html>
