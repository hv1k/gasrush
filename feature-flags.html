<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush — Feature Flags</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .role-tabs { display:flex; gap:8px; margin-bottom:24px; flex-wrap:wrap; }
        .role-tab {
            padding:10px 20px; border-radius:var(--radius-md); font-size:14px; font-weight:600;
            font-family:var(--font); cursor:pointer; border:1px solid var(--border);
            background:var(--bg-card); color:var(--text-secondary); transition:all .15s;
        }
        .role-tab:hover { background:var(--bg-hover); color:var(--text-primary); }
        .role-tab.active { background:var(--primary); color:white; border-color:var(--primary); }

        .sidebar-preview {
            background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg);
            max-width:500px; overflow:hidden;
        }

        .section-label {
            padding:12px 20px 6px; font-size:11px; font-weight:600; color:var(--text-muted);
            text-transform:uppercase; letter-spacing:0.05em;
        }

        .nav-item {
            display:flex; align-items:center; justify-content:space-between;
            padding:10px 20px; transition:background .1s;
        }
        .nav-item:hover { background:var(--bg-hover); }

        .nav-item-left {
            display:flex; align-items:center; gap:12px;
        }
        .nav-item-icon { font-size:18px; width:24px; text-align:center; }
        .nav-item-label { font-size:14px; font-weight:500; color:var(--text-primary); }
        .nav-item.disabled .nav-item-label { color:var(--text-muted); text-decoration:line-through; }
        .nav-item.no-flag .nav-item-label { color:var(--text-secondary); }

        .toggle { position:relative; width:44px; height:24px; flex-shrink:0; cursor:pointer; }
        .toggle input { opacity:0; width:0; height:0; position:absolute; }
        .toggle-track {
            position:absolute; inset:0; background:var(--border); border-radius:12px; transition:background .2s;
        }
        .toggle-track::after {
            content:''; position:absolute; width:18px; height:18px; left:3px; top:3px;
            background:white; border-radius:50%; transition:transform .2s; box-shadow:0 1px 3px rgba(0,0,0,0.15);
        }
        .toggle input:checked + .toggle-track { background:var(--success); }
        .toggle input:checked + .toggle-track::after { transform:translateX(20px); }

        .always-on {
            font-size:11px; color:var(--text-muted); font-weight:500; padding:4px 10px;
            background:var(--bg-body); border-radius:var(--radius-sm);
        }

        .stats-row { display:flex; gap:16px; margin-bottom:24px; flex-wrap:wrap; }
        .mini-stat {
            background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-md);
            padding:12px 20px; display:flex; align-items:center; gap:10px;
        }
        .mini-stat-value { font-size:20px; font-weight:700; color:var(--text-primary); }
        .mini-stat-label { font-size:13px; color:var(--text-secondary); }

        @media (max-width:768px) {
            .sidebar-preview { max-width:100%; }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">⛽</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>Feature Flags</h1>
                <p class="text-muted">Toggle sidebar pages on/off per role — changes apply instantly</p>
            </div>

            <div class="role-tabs" id="roleTabs"></div>
            <div class="stats-row" id="statsRow"></div>
            <div id="flagsContainer"></div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let allFlags = [];
        let activeRole = 'rental';
        const roles = ['rental', 'vendor', 'fieldworker'];

        const sectionLabels = {
            main: 'MAIN', management: 'MANAGEMENT', team: 'TEAM',
            tools: 'TOOLS', settings: 'SETTINGS', admin: 'ADMIN'
        };

        (async () => {
            const user = await GasRush.init({ roles: ['admin'] });
            if (!user) return;
            await loadFlags();
        })();

        async function loadFlags() {
            try {
                const { data, error } = await GasRush.db().from('feature_flags').select('*');
                if (error) throw error;
                allFlags = data || [];
                renderTabs();
                renderRole();
            } catch(e) {
                console.error(e);
                document.getElementById('flagsContainer').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">⚠️</div><h3>Failed to load flags</h3></div>';
            }
        }

        function renderTabs() {
            document.getElementById('roleTabs').innerHTML = roles.map(role => {
                const active = role === activeRole ? ' active' : '';
                const label = role.charAt(0).toUpperCase() + role.slice(1);
                return `<button class="role-tab${active}" onclick="switchRole('${role}')">${label}</button>`;
            }).join('');
        }

        function getFlag(featureKey, role) {
            return allFlags.find(f => f.feature_key === featureKey && f.role === role);
        }

        function renderRole() {
            const nav = GasRush.NAV_CONFIG[activeRole];
            if (!nav) return;

            const roleFlags = allFlags.filter(f => f.role === activeRole);
            const flagged = roleFlags.filter(f => f.feature_key && f.feature_key.startsWith('page.'));
            const on = flagged.filter(f => f.enabled).length;

            document.getElementById('statsRow').innerHTML = `
                <div class="mini-stat"><span class="mini-stat-value">${flagged.length}</span><span class="mini-stat-label">Toggleable Pages</span></div>
                <div class="mini-stat"><span class="mini-stat-value" style="color:var(--success)">${on}</span><span class="mini-stat-label">Enabled</span></div>
                <div class="mini-stat"><span class="mini-stat-value" style="color:var(--text-muted)">${flagged.length - on}</span><span class="mini-stat-label">Disabled</span></div>
            `;

            let html = '<div class="sidebar-preview">';

            for (const [section, items] of Object.entries(nav)) {
                html += `<div class="section-label">${sectionLabels[section] || section.toUpperCase()}</div>`;

                for (const item of items) {
                    if (!item.flag) {
                        // No flag = always on (dashboard, settings)
                        html += `<div class="nav-item no-flag">
                            <div class="nav-item-left">
                                <span class="nav-item-icon">${item.icon}</span>
                                <span class="nav-item-label">${esc(item.label)}</span>
                            </div>
                            <span class="always-on">Always on</span>
                        </div>`;
                    } else {
                        const flag = getFlag(item.flag, activeRole);
                        const enabled = flag ? flag.enabled : true;
                        const disabledClass = enabled ? '' : ' disabled';
                        const flagId = flag ? flag.id : null;

                        html += `<div class="nav-item${disabledClass}" id="item-${flagId}">
                            <div class="nav-item-left">
                                <span class="nav-item-icon">${item.icon}</span>
                                <span class="nav-item-label">${esc(item.label)}</span>
                            </div>
                            ${flagId
                                ? `<label class="toggle"><input type="checkbox" ${enabled ? 'checked' : ''} onchange="toggleFlag('${flagId}', this.checked, '${item.flag}')"><span class="toggle-track"></span></label>`
                                : '<span class="always-on">No flag</span>'
                            }
                        </div>`;
                    }
                }
            }

            html += '</div>';
            document.getElementById('flagsContainer').innerHTML = html;
        }

        function switchRole(role) {
            activeRole = role;
            renderTabs();
            renderRole();
        }

        async function toggleFlag(id, enabled, flagKey) {
            try {
                await GasRush.db().from('feature_flags').update({ enabled }).eq('id', id);
                const flag = allFlags.find(f => f.id === id);
                if (flag) flag.enabled = enabled;
                // Update UI inline
                const item = document.getElementById('item-' + id);
                if (item) {
                    if (enabled) item.classList.remove('disabled');
                    else item.classList.add('disabled');
                }
                // Update stats
                renderRole();
            } catch(e) {
                console.error('Toggle failed:', e);
                alert('Failed to update flag');
            }
        }

        function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    </script>
</body>
</html>
