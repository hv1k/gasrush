<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush â€” Chat</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .chat-container { display:flex; flex-direction:column; height:calc(100vh - 140px); }
        .chat-messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:8px; }
        .chat-bubble { max-width:70%; padding:10px 14px; border-radius:12px; font-size:14px; line-height:1.4; }
        .chat-bubble.sent { align-self:flex-end; background:var(--color-primary); color:#fff; border-bottom-right-radius:4px; }
        .chat-bubble.received { align-self:flex-start; background:var(--color-card-bg, #2a2a3e); border-bottom-left-radius:4px; }
        .chat-meta { font-size:11px; opacity:0.6; margin-top:4px; }
        .chat-input-bar { display:flex; gap:8px; padding:12px 16px; border-top:1px solid var(--color-border, #333); }
        .chat-input-bar input { flex:1; }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">â›½</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content" style="padding:0;display:flex;flex-direction:column">
            <div class="page-header" style="padding:16px 20px;margin:0">
                <h1>Chat</h1>
                <p class="text-secondary">Team messaging</p>
            </div>

            <div class="card" style="flex:1;margin:0 16px 16px;display:flex;flex-direction:column;overflow:hidden">
                <div class="chat-messages" id="messages"></div>
                <div class="chat-input-bar">
                    <input class="form-input" id="msgInput" placeholder="Type a messageâ€¦" onkeydown="if(event.key==='Enter')sendMsg()">
                    <button class="btn btn-primary" onclick="sendMsg()">Send</button>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let currentUser;

        (async () => {
            currentUser = await GasRush.init({ roles: ['vendor', 'fieldworker', 'admin'] });
            if (!currentUser) return;
            await loadMessages();
            setInterval(loadMessages, 10000);
        })();

        async function loadMessages() {
            let rows = [];
            try {
                const { data, error } = await GasRush.db().from('messages').select('*').order('created_at', { ascending: true }).limit(100);
                if (error) throw error;
                rows = data || [];
            } catch(e) { console.warn('Messages table not available:', e.message); }
            renderMessages(rows);
        }

        function renderMessages(rows) {
            const c = document.getElementById('messages');
            if (!rows.length) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ’¬</div><h3>No messages yet</h3><p>Start the conversation!</p></div>'; return; }
            let h = '';
            for (const m of rows) {
                const mine = m.sender_id === currentUser.id;
                const time = m.created_at ? new Date(m.created_at).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) : '';
                h += `<div class="chat-bubble ${mine ? 'sent' : 'received'}">`;
                if (!mine) h += `<div style="font-weight:600;font-size:12px;margin-bottom:2px">${esc(m.sender_name||'User')}</div>`;
                h += `${esc(m.text||m.content||'')}<div class="chat-meta">${time}</div></div>`;
            }
            c.innerHTML = h;
            c.scrollTop = c.scrollHeight;
        }

        async function sendMsg() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            try {
                const { error } = await GasRush.db().from('messages').insert([{ text, sender_id: currentUser.id, sender_name: currentUser.name }]);
                if (error) throw error;
            } catch(e) { console.warn('Send failed:', e.message); }
            await loadMessages();
        }

        function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    </script>
</body>
</html>
