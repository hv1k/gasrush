<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush ‚Äî Job Sites</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .site-card {
            background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg);
            padding:20px; cursor:pointer; transition:all .15s;
        }
        .site-card:hover { border-color:var(--primary); box-shadow:var(--shadow-md); transform:translateY(-1px); }
        .site-name { font-size:16px; font-weight:700; color:var(--text-primary); margin-bottom:4px; }
        .site-location { font-size:13px; color:var(--text-secondary); margin-bottom:12px; }
        .site-stats { display:flex; gap:16px; flex-wrap:wrap; }
        .site-stat { text-align:center; }
        .site-stat-value { font-size:20px; font-weight:700; color:var(--text-primary); }
        .site-stat-label { font-size:11px; color:var(--text-muted); text-transform:uppercase; }
        .sites-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:16px; }
        .search-row { display:flex; gap:12px; margin-bottom:24px; flex-wrap:wrap; align-items:center; }
        .search-row input { max-width:360px; }
        .view-toggle { display:flex; border:1px solid var(--border); border-radius:var(--radius-md); overflow:hidden; }
        .view-btn {
            padding:8px 14px; font-size:13px; font-family:var(--font); cursor:pointer;
            border:none; background:var(--bg-card); color:var(--text-secondary); transition:all .15s;
        }
        .view-btn:not(:last-child) { border-right:1px solid var(--border); }
        .view-btn.active { background:var(--primary); color:white; }
        .view-btn:hover:not(.active) { background:var(--bg-hover); }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">‚õΩ</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>Job Sites</h1>
                <p class="text-muted">All job sites with fuel consumption history</p>
            </div>

            <div class="stats-grid" id="topStats"></div>

            <div class="search-row">
                <input type="text" class="form-input" placeholder="Search job sites..." id="searchInput" oninput="renderSites()">
                <select class="form-select" id="sortBy" style="width:200px" onchange="renderSites()">
                    <option value="jobs">Most Jobs</option>
                    <option value="gallons">Most Gallons</option>
                    <option value="recent">Most Recent</option>
                    <option value="alpha">A-Z</option>
                </select>
                <div class="view-toggle">
                    <button class="view-btn active" id="viewCards" onclick="setView('cards')">‚óªÔ∏è Cards</button>
                    <button class="view-btn" id="viewList" onclick="setView('list')">‚ò∞ List</button>
                    <button class="view-btn" id="viewTable" onclick="setView('table')">üìä Table</button>
                </div>
            </div>

            <div class="sites-grid" id="sitesGrid">
                <div class="empty-state"><div class="empty-state-icon">‚è≥</div><h3>Loading...</h3></div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let sites = {};
        let currentUser;

        (async () => {
            currentUser = await GasRush.init({ roles: ['rental', 'vendor', 'fieldworker', 'admin'] });
            if (!currentUser) return;
            await loadData();
        })();

        async function loadData() {
            try {
                let query = GasRush.db().from('jobs').select('*').order('created_at', { ascending: false });

                if (currentUser.role === 'rental') query = query.eq('created_by', currentUser.id);
                if (currentUser.role === 'vendor') query = query.eq('assigned_vendor', currentUser.vendor_id);
                if (currentUser.role === 'fieldworker') query = query.eq('assigned_worker', currentUser.id);

                const { data, error } = await query;
                if (error) throw error;

                // Get all job IDs to fetch deliveries
                const jobIds = (data || []).map(j => j.id);
                let deliveriesByJob = {};
                if (jobIds.length > 0) {
                    const { data: deliveries } = await window.__supabase
                        .from('deliveries')
                        .select('job_id, gallons, def_gallons, timestamp')
                        .in('job_id', jobIds);
                    for (const d of (deliveries || [])) {
                        if (!deliveriesByJob[d.job_id]) deliveriesByJob[d.job_id] = [];
                        deliveriesByJob[d.job_id].push(d);
                    }
                }

                // Group by job site name
                sites = {};
                for (const job of (data || [])) {
                    const name = (job.job_site_name || 'Unknown Site').trim();
                    if (!sites[name]) {
                        sites[name] = {
                            name,
                            city: job.address_city || '',
                            state: job.address_state || '',
                            address: job.address_street || '',
                            jobs: [],
                            totalFuel: 0,
                            totalDef: 0,
                            completed: 0,
                            lastDate: null
                        };
                    }
                    const s = sites[name];
                    s.jobs.push(job);
                    // Sum from actual deliveries
                    const jobDeliveries = deliveriesByJob[job.id] || [];
                    for (const del of jobDeliveries) {
                        s.totalFuel += parseFloat(del.gallons) || 0;
                        s.totalDef += parseFloat(del.def_gallons) || 0;
                        const dt = del.timestamp ? new Date(del.timestamp) : null;
                        if (dt && (!s.lastDate || dt > s.lastDate)) s.lastDate = dt;
                    }
                    if (job.status === 'completed') s.completed++;
                    if (!s.lastDate) {
                        const d = job.created_at ? new Date(job.created_at) : null;
                        if (d && (!s.lastDate || d > s.lastDate)) s.lastDate = d;
                    }
                }

                // Top stats
                const allSites = Object.values(sites);
                const totalJobs = allSites.reduce((s, x) => s + x.jobs.length, 0);
                const totalFuel = allSites.reduce((s, x) => s + x.totalFuel, 0);
                const totalDef = allSites.reduce((s, x) => s + x.totalDef, 0);
                document.getElementById('topStats').innerHTML = `
                    <div class="stat-card"><div class="stat-label">Total Sites</div><div class="stat-value">${allSites.length}</div></div>
                    <div class="stat-card"><div class="stat-label">Total Jobs</div><div class="stat-value">${totalJobs}</div></div>
                    <div class="stat-card"><div class="stat-label">Total Fuel</div><div class="stat-value">${totalFuel.toLocaleString()}</div><div class="stat-sub">gallons</div></div>
                    <div class="stat-card"><div class="stat-label">Total DEF</div><div class="stat-value">${totalDef.toLocaleString()}</div><div class="stat-sub">gallons</div></div>
                `;

                renderSites();
            } catch(e) {
                console.error(e);
                document.getElementById('sitesGrid').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h3>Failed to load</h3></div>';
            }
        }

        let currentView = 'cards';

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');
            renderSites();
        }

        function getFilteredSites() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sort = document.getElementById('sortBy').value;
            let list = Object.values(sites);

            if (search) {
                list = list.filter(s =>
                    s.name.toLowerCase().includes(search) ||
                    s.city.toLowerCase().includes(search) ||
                    s.address.toLowerCase().includes(search)
                );
            }

            if (sort === 'jobs') list.sort((a, b) => b.jobs.length - a.jobs.length);
            else if (sort === 'gallons') list.sort((a, b) => (b.totalFuel + b.totalDef) - (a.totalFuel + a.totalDef));
            else if (sort === 'recent') list.sort((a, b) => (b.lastDate || 0) - (a.lastDate || 0));
            else if (sort === 'alpha') list.sort((a, b) => a.name.localeCompare(b.name));

            return list;
        }

        function renderSites() {
            const list = getFilteredSites();
            const grid = document.getElementById('sitesGrid');

            if (!list.length) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><h3>No sites found</h3></div>';
                return;
            }

            if (currentView === 'cards') {
                grid.className = 'sites-grid';
                grid.innerHTML = list.map(s => `
                    <div class="site-card" onclick="window.location.href='job-site-detail.html?site=${encodeURIComponent(s.name)}'">
                        <div class="site-name">${esc(s.name)}</div>
                        <div class="site-location">üìç ${esc([s.address, s.city, s.state].filter(Boolean).join(', ') || 'No address')}</div>
                        <div class="site-stats">
                            <div class="site-stat"><div class="site-stat-value">${s.jobs.length}</div><div class="site-stat-label">Jobs</div></div>
                            <div class="site-stat"><div class="site-stat-value">${s.completed}</div><div class="site-stat-label">Completed</div></div>
                            <div class="site-stat"><div class="site-stat-value">${s.totalFuel.toLocaleString()}</div><div class="site-stat-label">Fuel gal</div></div>
                            <div class="site-stat"><div class="site-stat-value">${s.totalDef.toLocaleString()}</div><div class="site-stat-label">DEF gal</div></div>
                            <div class="site-stat"><div class="site-stat-value">${s.lastDate ? s.lastDate.toLocaleDateString() : '‚Äî'}</div><div class="site-stat-label">Last Activity</div></div>
                        </div>
                    </div>
                `).join('');

            } else if (currentView === 'list') {
                grid.className = '';
                grid.innerHTML = list.map(s => `
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);cursor:pointer;background:var(--bg-card);transition:background .1s"
                         onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='var(--bg-card)'"
                         onclick="window.location.href='job-site-detail.html?site=${encodeURIComponent(s.name)}'">
                        <div style="flex:1;min-width:0">
                            <div style="font-weight:600;font-size:14px;color:var(--text-primary)">${esc(s.name)}</div>
                            <div style="font-size:12px;color:var(--text-muted)">${esc([s.city, s.state].filter(Boolean).join(', '))}</div>
                        </div>
                        <div style="display:flex;gap:24px;font-size:13px;color:var(--text-secondary);flex-shrink:0">
                            <span><strong>${s.jobs.length}</strong> jobs</span>
                            <span><strong>${s.totalFuel.toLocaleString()}</strong> gal</span>
                            <span>${s.lastDate ? s.lastDate.toLocaleDateString() : '‚Äî'}</span>
                        </div>
                    </div>
                `).join('');

            } else if (currentView === 'table') {
                grid.className = '';
                const pending = s => s.jobs.filter(j => ['pending','created'].includes(j.status)).length;
                const active = s => s.jobs.filter(j => ['active','assigned','in-progress','accepted'].includes(j.status)).length;
                let html = `<div class="table-wrapper" style="border-radius:var(--radius-lg);overflow:hidden">
                <table style="font-size:13px">
                <thead><tr>
                    <th style="width:30px">#</th>
                    <th style="text-align:left">SITE</th>
                    <th style="text-align:left">CITY</th>
                    <th style="text-align:right">JOBS</th>
                    <th style="text-align:right">PENDING</th>
                    <th style="text-align:right">ACTIVE</th>
                    <th style="text-align:right">DONE</th>
                    <th style="text-align:right">DIESEL</th>
                    <th style="text-align:right">DEF</th>
                    <th style="text-align:right">TOTAL GAL</th>
                    <th style="text-align:right">LAST ACTIVITY</th>
                </tr></thead><tbody>`;
                list.forEach((s, i) => {
                    const p = s.jobs.filter(j => ['pending','created'].includes(j.status)).length;
                    const a = s.jobs.filter(j => ['active','assigned','in-progress','accepted'].includes(j.status)).length;
                    const total = s.totalFuel + s.totalDef;
                    const fuelColor = s.totalFuel > 0 ? 'var(--warning)' : 'var(--text-muted)';
                    const defColor = s.totalDef > 0 ? 'var(--primary)' : 'var(--text-muted)';
                    html += `<tr style="cursor:pointer" onclick="window.location.href='job-site-detail.html?site=${encodeURIComponent(s.name)}'">
                        <td style="color:var(--text-muted);text-align:center">${i + 1}</td>
                        <td><strong style="color:var(--text-primary)">${esc(s.name)}</strong></td>
                        <td style="color:var(--text-secondary)">${esc([s.city, s.state].filter(Boolean).join(', '))}</td>
                        <td style="text-align:right;font-weight:600">${s.jobs.length}</td>
                        <td style="text-align:right;color:${p > 0 ? 'var(--warning)' : 'var(--text-muted)'}">${p}</td>
                        <td style="text-align:right;color:${a > 0 ? 'var(--primary)' : 'var(--text-muted)'}">${a}</td>
                        <td style="text-align:right;color:${s.completed > 0 ? 'var(--success)' : 'var(--text-muted)'}">${s.completed}</td>
                        <td style="text-align:right;color:${fuelColor};font-weight:600">${s.totalFuel > 0 ? s.totalFuel.toLocaleString() : '‚Äî'}</td>
                        <td style="text-align:right;color:${defColor};font-weight:600">${s.totalDef > 0 ? s.totalDef.toLocaleString() : '‚Äî'}</td>
                        <td style="text-align:right;font-weight:700;color:var(--text-primary)">${total > 0 ? total.toLocaleString() : '‚Äî'}</td>
                        <td style="text-align:right;color:var(--text-secondary)">${s.lastDate ? s.lastDate.toLocaleDateString() : '‚Äî'}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                grid.innerHTML = html;
            }
        }

        function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    </script>
</body>
</html>
