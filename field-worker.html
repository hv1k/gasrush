<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush ‚Äî Field Worker</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        /* Job List */
        .job-cards { display: flex; flex-direction: column; gap: 12px; }
        .job-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; display: flex; flex-direction: column; gap: 8px;
        }
        .job-card.active-job { border: 2px solid var(--primary); background: var(--bg-card); }
        .job-card-header { display: flex; justify-content: space-between; align-items: start; }
        .job-card-title { font-weight: 600; font-size: 17px; color: var(--text-primary); }
        .job-card-detail { color: var(--text-secondary); font-size: 14px; }
        .job-card-detail a { color: var(--primary); text-decoration: none; }
        .job-card .btn { min-height: 48px; font-size: 16px; margin-top: 4px; }

        /* Detail View */
        .detail-view { display: none; }
        .detail-view.visible { display: block; }
        .back-link { display: inline-block; padding: 12px 0; font-size: 16px; color: var(--primary); cursor: pointer; text-decoration: none; min-height: 44px; }
        .job-info { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border); }
        .job-info h2 { margin: 0 0 8px; font-size: 20px; color: var(--text-primary); }
        .job-info p { margin: 4px 0; color: var(--text-secondary); font-size: 15px; }
        .job-info a { color: var(--primary); text-decoration: none; }

        .equipment-list { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border); }
        .equipment-list h3 { margin: 0 0 12px; font-size: 16px; color: var(--text-primary); }
        .equipment-item { padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text-secondary); }
        .equipment-item:last-child { border-bottom: none; }

        .unit-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; margin-bottom: 12px;
        }
        .unit-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .unit-card-header h4 { margin: 0; font-size: 16px; color: var(--text-primary); }
        .unit-card .remove-btn { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
        .field-group { margin-bottom: 12px; }
        .field-group label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
        .field-group input, .field-group textarea {
            width: 100%; box-sizing: border-box;
            background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px;
            padding: 14px 16px; color: var(--text-primary); font-size: 18px;
        }
        .field-group input:focus, .field-group textarea:focus { border-color: var(--primary); outline: none; }
        .field-group input[type="number"] { font-size: 20px; font-weight: 600; }
        .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .add-unit-btn {
            width: 100%; min-height: 48px; font-size: 16px; background: var(--bg-secondary);
            border: 2px dashed var(--border); border-radius: 12px; color: var(--primary);
            cursor: pointer; margin-bottom: 16px;
        }
        .notes-section { margin-bottom: 16px; }
        .notes-section textarea { min-height: 80px; resize: vertical; font-size: 16px; }

        .complete-btn {
            width: 100%; min-height: 56px; font-size: 18px; font-weight: 600;
            background: var(--primary); color: white; border: none; border-radius: 12px;
            cursor: pointer; margin-bottom: 32px;
        }
        .complete-btn:active { opacity: 0.85; }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand"><div class="logo">‚õΩ</div><span class="brand-name">GasRush</span></div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <!-- Job List View -->
            <div id="listView">
                <div class="page-header">
                    <h1>My Jobs</h1>
                    <p id="greeting">Welcome back</p>
                </div>
                <div id="jobsContainer" class="job-cards">
                    <div class="empty-state"><div class="empty-state-icon">üöõ</div><h3>Loading...</h3></div>
                </div>
            </div>

            <!-- Job Detail View -->
            <div id="detailView" class="detail-view">
                <a class="back-link" onclick="showListView()">‚Üê Back to Jobs</a>
                <div id="detailContent"></div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let currentUser = null;
        let allJobs = [];
        let activeJobId = null;
        let unitCounter = 0;
        let jobEquipment = [];

        (async () => {
            const user = await GasRush.init({ roles: ['fieldworker', 'admin'] });
            if (!user) return;
            currentUser = user;

            const hour = new Date().getHours();
            const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
            document.getElementById('greeting').textContent = `${greet}, ${user.name}`;

            await loadJobs();
        })();

        async function loadJobs() {
            try {
                let query = GasRush.db().from('jobs').select('*').order('created_at', { ascending: false });
                if (currentUser.role === 'fieldworker') {
                    query = query.eq('assigned_worker', currentUser.id);
                }
                const { data: jobs, error } = await query;
                if (error) throw error;
                allJobs = jobs || [];
                renderJobs();
            } catch(e) {
                console.error('Failed to load:', e);
                document.getElementById('jobsContainer').innerHTML = '<div class="empty-state"><h3>Failed to load jobs</h3></div>';
            }
        }

        function renderJobs() {
            const container = document.getElementById('jobsContainer');
            const visible = allJobs.filter(j => j.status !== 'completed' && j.status !== 'cancelled');

            if (!visible.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üöõ</div><h3>No jobs assigned</h3><p>Check back later for new assignments</p></div>';
                return;
            }

            // Sort: active/in-progress first, then assigned/pending
            const active = visible.filter(j => ['active','in-progress'].includes(j.status));
            const assigned = visible.filter(j => !['active','in-progress'].includes(j.status));
            const sorted = [...active, ...assigned];

            container.innerHTML = sorted.map(job => {
                const isActive = ['active','in-progress'].includes(job.status);
                const loc = [job.address_street, job.address_city, job.address_state].filter(Boolean).join(', ') || '‚Äî';
                const badge = isActive ? '<span class="badge badge-success">üî¥ In Progress</span>' : `<span class="badge badge-primary">${esc(job.status)}</span>`;
                const phone = job.contact_phone ? `<a href="tel:${esc(job.contact_phone)}">${esc(job.contact_phone)}</a>` : '';
                const btn = isActive
                    ? `<button class="btn btn-primary" onclick="openJob('${job.id}')">Continue ‚Üí</button>`
                    : `<button class="btn btn-primary" onclick="startJob('${job.id}')">‚ñ∂Ô∏è Start Job</button>`;

                return `<div class="job-card ${isActive ? 'active-job' : ''}">
                    <div class="job-card-header">
                        <div class="job-card-title">${esc(job.job_site_name || 'Untitled')}</div>
                        ${badge}
                    </div>
                    <div class="job-card-detail">üìç ${esc(loc)}</div>
                    ${job.customer_name ? `<div class="job-card-detail">üë§ ${esc(job.customer_name)}</div>` : ''}
                    ${job.contact_name ? `<div class="job-card-detail">üìû ${esc(job.contact_name)} ${phone}</div>` : ''}
                    ${btn}
                </div>`;
            }).join('');
        }

        async function startJob(id) {
            try {
                const job = allJobs.find(j => j.id === id);
                const oldStatus = job?.status || 'unknown';
                const { error } = await GasRush.db().from('jobs').update({ status: 'active' }).eq('id', id);
                if (error) throw error;
                await logAudit(id, 'status_change', { from: oldStatus, to: 'active' });
                await loadJobs();
            } catch(e) {
                alert('Failed to start: ' + (e.message || e));
            }
        }

        async function openJob(id) {
            activeJobId = id;
            unitCounter = 0;
            jobEquipment = [];

            const job = allJobs.find(j => j.id === id);
            if (!job) return;

            // Fetch equipment
            try {
                const { data } = await GasRush.db().from('equipment').select('*').eq('job_id', id);
                jobEquipment = data || [];
            } catch(e) { console.warn('Equipment fetch failed:', e); }

            const loc = [job.address_street, job.address_city, job.address_state].filter(Boolean).join(', ') || '‚Äî';
            const phone = job.contact_phone ? `<a href="tel:${esc(job.contact_phone)}">${esc(job.contact_phone)}</a>` : '';

            let html = `<div class="job-info">
                <h2>${esc(job.job_site_name || 'Untitled')}</h2>
                <p>üìç ${esc(loc)}</p>
                ${job.customer_name ? `<p>üë§ ${esc(job.customer_name)}</p>` : ''}
                ${job.contact_name ? `<p>üìû ${esc(job.contact_name)} ${phone}</p>` : ''}
            </div>`;

            // Equipment list
            if (jobEquipment.length) {
                html += `<div class="equipment-list"><h3>üìã Equipment on Work Order</h3>`;
                html += jobEquipment.map(eq =>
                    `<div class="equipment-item"><strong>${esc(eq.equipment_number || '‚Äî')}</strong> ‚Äî ${esc(eq.description || 'No description')} ${eq.quantity > 1 ? `(√ó${eq.quantity})` : ''}</div>`
                ).join('');
                html += `</div>`;
            }

            // Fuel entry section
            html += `<h3 style="margin:16px 0 12px;color:var(--text-primary)">‚õΩ Fuel Entry</h3>`;
            html += `<div id="unitsContainer"></div>`;
            html += `<button class="add-unit-btn" onclick="addUnit()">+ Add Unit</button>`;

            // Notes
            html += `<div class="notes-section"><div class="field-group"><label>Notes (optional)</label><textarea id="jobNotes" placeholder="Any notes about this delivery..."></textarea></div></div>`;

            // Complete button
            html += `<button class="complete-btn" onclick="submitDelivery()">üìã Submit Delivery</button>`;

            document.getElementById('detailContent').innerHTML = html;

            // Pre-populate units from equipment or add one blank
            if (jobEquipment.length) {
                jobEquipment.forEach(eq => addUnit(eq.equipment_number));
            } else {
                addUnit();
            }

            document.getElementById('listView').style.display = 'none';
            document.getElementById('detailView').classList.add('visible');
            window.scrollTo(0, 0);
        }

        function addUnit(prefillNumber) {
            const idx = unitCounter++;
            const container = document.getElementById('unitsContainer');
            const div = document.createElement('div');
            div.className = 'unit-card';
            div.id = `unit-${idx}`;
            div.innerHTML = `
                <div class="unit-card-header">
                    <h4>Unit ${idx + 1}</h4>
                    ${idx > 0 || unitCounter > 1 ? `<button class="remove-btn" onclick="document.getElementById('unit-${idx}').remove()">‚úï</button>` : '<div></div>'}
                </div>
                <div class="field-group">
                    <label>Unit #</label>
                    <input type="text" id="unum-${idx}" value="${esc(prefillNumber || '')}" placeholder="e.g. A0147">
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Diesel (gal)</label>
                        <input type="number" id="udiesel-${idx}" step="0.1" min="0" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="field-group">
                        <label>DEF (gal)</label>
                        <input type="number" id="udef-${idx}" step="0.1" min="0" placeholder="0" inputmode="decimal">
                    </div>
                </div>
                <div class="field-group">
                    <label>Gen Hours Reading (optional)</label>
                    <input type="number" id="uhours-${idx}" step="0.1" min="0" placeholder="‚Äî" inputmode="decimal">
                </div>`;
            container.appendChild(div);
        }

        function showListView() {
            activeJobId = null;
            document.getElementById('detailView').classList.remove('visible');
            document.getElementById('listView').style.display = '';
            window.scrollTo(0, 0);
        }

        async function submitDelivery() {
            const jid = activeJobId;
            if (!jid) return;

            // Collect units
            const units = [];
            let totalDiesel = 0, totalDef = 0;
            document.querySelectorAll('#unitsContainer .unit-card').forEach(card => {
                const idx = card.id.split('-')[1];
                const num = document.getElementById(`unum-${idx}`)?.value?.trim() || '';
                const diesel = parseFloat(document.getElementById(`udiesel-${idx}`)?.value) || 0;
                const def = parseFloat(document.getElementById(`udef-${idx}`)?.value) || 0;
                const hours = parseFloat(document.getElementById(`uhours-${idx}`)?.value) || null;
                if (num || diesel || def) {
                    units.push({ unit_number: num, diesel, def, gen_hours: hours });
                    totalDiesel += diesel;
                    totalDef += def;
                }
            });

            if (!units.length || (totalDiesel === 0 && totalDef === 0)) {
                alert('Please enter fuel data for at least one unit.');
                return;
            }

            const notes = document.getElementById('jobNotes')?.value?.trim() || '';

            // Summary confirmation
            let msg = `Submit this delivery?\n\n`;
            msg += units.map(u => `Unit ${u.unit_number || '‚Äî'}: ${u.diesel}gal diesel, ${u.def}gal DEF${u.gen_hours ? ', ' + u.gen_hours + 'hrs' : ''}`).join('\n');
            msg += `\n\nTotal: ${totalDiesel} gal diesel, ${totalDef} gal DEF`;
            if (notes) msg += `\n\nNotes: ${notes}`;
            msg += `\n\nJob will remain active for future deliveries.`;
            if (!confirm(msg)) return;

            try {
                const job = allJobs.find(j => j.id === jid);

                // Save each unit as a delivery record
                for (const u of units) {
                    await GasRush.db().from('deliveries').insert({
                        job_id: jid,
                        delivered_by: currentUser.id?.length === 36 ? currentUser.id : null,
                        delivered_by_name: currentUser.name,
                        gallons: u.diesel,
                        def_gallons: u.def,
                        fuel_type: 'diesel',
                        unit_number: u.unit_number,
                        unit_hours: u.gen_hours,
                        notes: notes || null,
                        status: 'pending'
                    });
                }

                await logAudit(jid, 'delivery_submitted', { diesel: totalDiesel, def: totalDef, units });

                alert('‚úÖ Delivery submitted!');
                showListView();
                await loadJobs();
            } catch(e) {
                alert('Failed to submit: ' + (e.message || e));
            }
        }

        async function logAudit(jobId, action, details) {
            try {
                await GasRush.db().from('audit_logs').insert({
                    user_id: currentUser.id?.length === 36 ? currentUser.id : null,
                    user_name: currentUser.name || currentUser.email,
                    action, target_type: 'job', target_id: jobId, details
                });
            } catch(e) { console.warn('Audit log failed:', e); }
        }

        function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    </script>
</body>
</html>
