<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush ‚Äî Field Worker</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .job-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
        .job-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .job-card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .job-card-title { font-weight: 600; font-size: 16px; color: var(--text-primary); }
        .job-card-detail { color: var(--text-secondary); font-size: 14px; margin: 4px 0; }
        .job-card-actions { display: flex; gap: 8px; margin-top: 16px; }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">‚õΩ</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>My Jobs</h1>
                <p id="greeting">Welcome back</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Active Jobs</div>
                    <div class="stat-value" id="statActive">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completed Today</div>
                    <div class="stat-value" id="statToday">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Gallons Delivered</div>
                    <div class="stat-value" id="statGallons">‚Äî</div>
                    <div class="stat-sub">gal</div>
                </div>
            </div>

            <div class="card" style="background:transparent;border:none;box-shadow:none;padding:0;">
                <h2 style="margin-bottom:16px;">Assigned Jobs</h2>
                <div id="jobsContainer" class="job-cards">
                    <div class="empty-state"><div class="empty-state-icon">üöõ</div><h3>Loading...</h3></div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let currentUser = null;

        (async () => {
            const user = await GasRush.init({ roles: ['fieldworker', 'admin'] });
            if (!user) return;
            currentUser = user;

            const hour = new Date().getHours();
            const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
            document.getElementById('greeting').textContent = `${greet}, ${user.name}`;

            await loadData();
        })();

        async function loadData() {
            try {
                let query = GasRush.db().from('jobs').select('*').order('created_at', { ascending: false });

                if (currentUser.role === 'fieldworker') {
                    query = query.eq('assigned_worker', currentUser.id);
                }

                const { data: jobs, error } = await query;
                if (error) throw error;
                const all = jobs || [];

                const active = all.filter(j => ['active', 'assigned', 'pending'].includes(j.status)).length;
                const today = new Date().toISOString().slice(0, 10);
                const completedToday = all.filter(j => j.status === 'completed' && j.completed_at && j.completed_at.startsWith(today)).length;
                const gallons = all.filter(j => j.status === 'completed').reduce((s, j) => s + (parseFloat(j.billable_services?.fuelGallons || 0)), 0);

                document.getElementById('statActive').textContent = active;
                document.getElementById('statToday').textContent = completedToday;
                document.getElementById('statGallons').textContent = gallons.toLocaleString();

                renderJobs(all);
            } catch(e) {
                console.error('Failed to load:', e);
                renderJobs([]);
            }
        }

        function renderJobs(jobs) {
            const container = document.getElementById('jobsContainer');
            const activeJobs = jobs.filter(j => j.status !== 'completed' && j.status !== 'cancelled');

            if (activeJobs.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üöõ</div><h3>No jobs assigned</h3><p>Check back later for new assignments</p></div>`;
                return;
            }

            container.innerHTML = activeJobs.map(job => {
                const status = job.status || 'pending';
                const bc = status === 'completed' ? 'badge-success' : ['active','assigned'].includes(status) ? 'badge-primary' : 'badge-warning';
                const loc = [job.address_street, job.address_city, job.address_state].filter(Boolean).join(', ') || '‚Äî';
                const gal = job.billable_services?.fuelGallons || '‚Äî';
                const isActive = ['active', 'assigned', 'pending'].includes(status);

                let actions = '';
                if (status === 'pending' || status === 'assigned') {
                    actions = `<button class="btn btn-primary" onclick="updateStatus('${job.id}','active')">‚ñ∂Ô∏è Start</button>`;
                } else if (status === 'active') {
                    actions = `<button class="btn btn-primary" onclick="updateStatus('${job.id}','completed')">‚úÖ Complete</button>`;
                }

                return `<div class="job-card">
                    <div class="job-card-header">
                        <div class="job-card-title">${esc(job.job_site_name || 'Untitled')}</div>
                        <span class="badge ${bc}">${status}</span>
                    </div>
                    <div class="job-card-detail">üìç ${esc(loc)}</div>
                    <div class="job-card-detail">‚õΩ ${gal} gal</div>
                    ${job.customer_name ? `<div class="job-card-detail">üë§ ${esc(job.customer_name)}</div>` : ''}
                    ${job.notes ? `<div class="job-card-detail" style="margin-top:8px;font-style:italic;">${esc(job.notes)}</div>` : ''}
                    ${actions ? `<div class="job-card-actions">${actions}</div>` : ''}
                </div>`;
            }).join('');
        }

        async function updateStatus(id, status) {
            try {
                const update = { status };
                if (status === 'completed') update.completed_at = new Date().toISOString();
                // started_at column doesn't exist on jobs table

                const job = allJobs.find(j => j.id === id);
                const oldStatus = job?.status || 'unknown';

                const { error } = await GasRush.db().from('jobs').update(update).eq('id', id);
                if (error) throw error;

                // Audit log
                try {
                    await GasRush.db().from('audit_logs').insert({
                        user_id: currentUser.id?.length === 36 ? currentUser.id : null,
                        user_name: currentUser.name || currentUser.email,
                        action: 'status_change',
                        target_type: 'job',
                        target_id: id,
                        details: { from: oldStatus, to: status }
                    });
                } catch(e2) { console.warn('Audit log failed:', e2); }

                await loadData();
            } catch(e) {
                alert('Failed to update: ' + (e.message || e));
            }
        }

        function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    </script>
</body>
</html>
