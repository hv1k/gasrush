<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush ‚Äî Work Orders</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .job-detail { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:16px 0; }
        .job-detail-item label { font-size:12px; color:var(--text-muted); font-weight:600; text-transform:uppercase; }
        .job-detail-item .value { font-size:14px; color:var(--text-primary); margin-top:2px; }
        .actions-bar { display:flex; gap:8px; margin-top:20px; padding-top:16px; border-top:1px solid var(--border); flex-wrap:wrap; }
        @media(max-width:768px) { .job-detail { grid-template-columns:1fr; } }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">‚õΩ</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="page-header flex justify-between items-center">
                <div>
                    <h1>Work Orders</h1>
                    <p class="text-muted">Manage and track all work orders</p>
                </div>
                <div class="flex gap-2" id="headerActions">
                    <a href="create-job.html" class="btn btn-primary" id="createBtn">‚ûï Create Work Order</a>
                    <button class="btn btn-secondary" onclick="loadData()">üîÑ Refresh</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">All Work Orders</h2>
                    <div class="flex gap-2">
                        <input type="text" class="form-input" placeholder="Search..." id="searchInput" style="width:200px" oninput="filterOrders()">
                        <select class="form-select" id="statusFilter" style="width:160px" onchange="filterOrders()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="active">Active / Assigned</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div id="ordersContainer">
                    <div class="empty-state"><div class="empty-state-icon">üìã</div><h3>Loading...</h3></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Job Detail Modal -->
    <div class="modal-overlay" id="jobModal">
        <div class="modal" style="max-width:640px">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Job Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let allOrders = [];
        let currentUser = null;

        (async () => {
            currentUser = await GasRush.init({ roles: ['rental', 'vendor', 'fieldworker', 'admin'] });
            if (!currentUser) return;

            if (currentUser.role === 'fieldworker') {
                document.getElementById('createBtn').style.display = 'none';
            }
            await loadData();
        })();

        async function loadData() {
            try {
                let query = GasRush.db().from('jobs').select('*').order('created_at', { ascending: false });

                if (currentUser.role === 'fieldworker') {
                    query = query.eq('assigned_worker', currentUser.id);
                } else if (currentUser.role === 'vendor') {
                    // Vendors see their assigned jobs + all pending (unassigned) jobs
                    query = query.or(`assigned_vendor.eq.${currentUser.vendor_id},status.eq.pending,assigned_vendor.is.null`);
                }

                const { data, error } = await query;
                if (error) throw error;
                allOrders = data || [];
                filterOrders();
            } catch(e) {
                console.error('Load failed:', e);
                renderOrders([]);
            }
        }

        function filterOrders() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            let filtered = allOrders;

            if (status === 'pending') filtered = filtered.filter(j => ['pending','created'].includes(j.status));
            else if (status === 'active') filtered = filtered.filter(j => ['active','assigned'].includes(j.status));
            else if (status === 'completed') filtered = filtered.filter(j => j.status === 'completed');

            if (search) {
                filtered = filtered.filter(j =>
                    (j.job_site_name||'').toLowerCase().includes(search) ||
                    (j.address_street||'').toLowerCase().includes(search) ||
                    (j.address_city||'').toLowerCase().includes(search) ||
                    (j.contract_number||'').toLowerCase().includes(search) ||
                    (j.customer_name||'').toLowerCase().includes(search)
                );
            }
            renderOrders(filtered);
        }

        function renderOrders(orders) {
            const c = document.getElementById('ordersContainer');
            if (!orders.length) {
                c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìã</div><h3>No work orders found</h3><p>Try adjusting your filters</p></div>`;
                return;
            }

            let html = '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Job Site</th><th>City</th><th>Type</th><th>Status</th><th></th></tr></thead><tbody>';
            for (const j of orders) {
                const date = j.created_at ? new Date(j.created_at).toLocaleDateString() : '‚Äî';
                const name = j.job_site_name || j.contract_number || 'Untitled';
                const city = j.address_city || '‚Äî';
                const type = (j.job_type || 'delivery').replace('-', ' ');
                const status = j.status || 'pending';
                const bc = status === 'completed' ? 'badge-success' : ['active','assigned'].includes(status) ? 'badge-primary' : 'badge-warning';
                html += `<tr style="cursor:pointer" onclick="viewJob('${j.id}')">
                    <td>${date}</td><td><strong>${esc(name)}</strong></td><td>${esc(city)}</td>
                    <td style="text-transform:capitalize">${type}</td><td><span class="badge ${bc}">${status}</span></td>
                    <td><button class="btn btn-secondary" style="padding:4px 12px;font-size:12px">View</button></td>
                </tr>`;
            }
            html += '</tbody></table></div>';
            c.innerHTML = html;
        }

        async function viewJob(id) {
            const job = allOrders.find(j => j.id === id);
            if (!job) return;

            const modal = document.getElementById('jobModal');
            document.getElementById('modalTitle').textContent = job.job_site_name || 'Job Details';

            const status = job.status || 'pending';

            // Fetch equipment for this job
            let equipHtml = '';
            try {
                const { data: equip } = await GasRush.db().from('equipment').select('*').eq('job_id', id);
                if (equip && equip.length) {
                    equipHtml = `<div style="margin-top:16px"><label class="form-label" style="font-size:13px;color:var(--primary)">Equipment / Units</label>
                        <table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:6px">
                            <tr style="border-bottom:1px solid var(--border)"><th style="text-align:left;padding:6px 8px;color:var(--text-secondary)">QTY</th><th style="text-align:left;padding:6px 8px;color:var(--text-secondary)">Unit #</th><th style="text-align:left;padding:6px 8px;color:var(--text-secondary)">Description</th></tr>
                            ${equip.map(e => `<tr style="border-bottom:1px solid var(--border)"><td style="padding:6px 8px">${e.quantity||1}</td><td style="padding:6px 8px">${esc(e.equipment_number||'‚Äî')}</td><td style="padding:6px 8px">${esc(e.description||'‚Äî')}</td></tr>`).join('')}
                        </table></div>`;
                }
            } catch(e) { console.warn('Equipment load error:', e); }

            // Fetch previous completed jobs at same site
            let historyHtml = '';
            try {
                const { data: prev } = await GasRush.db().from('jobs').select('*')
                    .eq('job_site_name', job.job_site_name)
                    .eq('status', 'completed')
                    .neq('id', id)
                    .order('completed_at', { ascending: false })
                    .limit(10);
                if (prev && prev.length) {
                    historyHtml = `<div style="margin-top:16px"><label class="form-label" style="font-size:13px;color:var(--primary)">Previous Deliveries to This Site</label>
                        <table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:6px">
                            <tr style="border-bottom:1px solid var(--border)"><th style="text-align:left;padding:6px 8px;color:var(--text-secondary)">Date</th><th style="text-align:left;padding:6px 8px;color:var(--text-secondary)">Type</th><th style="text-align:left;padding:6px 8px;color:var(--text-secondary)">Diesel</th><th style="text-align:left;padding:6px 8px;color:var(--text-secondary)">DEF</th></tr>
                            ${prev.map(p => {
                                const d = p.completed_at ? new Date(p.completed_at).toLocaleDateString() : '‚Äî';
                                const fuel = p.billable_services?.fuelGallons || '‚Äî';
                                const def = p.billable_services?.defGallons || '‚Äî';
                                return `<tr style="border-bottom:1px solid var(--border)"><td style="padding:6px 8px">${d}</td><td style="padding:6px 8px;text-transform:capitalize">${(p.job_type||'delivery').replace('-',' ')}</td><td style="padding:6px 8px">${fuel} gal</td><td style="padding:6px 8px">${def} gal</td></tr>`;
                            }).join('')}
                        </table></div>`;
                } else {
                    historyHtml = `<div style="margin-top:16px"><label class="form-label" style="font-size:13px;color:var(--primary)">Previous Deliveries to This Site</label><p style="font-size:13px;color:var(--text-muted);margin-top:4px">No previous completed deliveries</p></div>`;
                }
            } catch(e) { console.warn('History load error:', e); }

            let html = `
                <div class="job-detail">
                    <div class="job-detail-item"><label>Status</label><div class="value"><span class="badge ${status==='completed'?'badge-success':['active','assigned'].includes(status)?'badge-primary':'badge-warning'}">${status}</span></div></div>
                    <div class="job-detail-item"><label>Type</label><div class="value" style="text-transform:capitalize">${(job.job_type||'delivery').replace('-',' ')}</div></div>
                    <div class="job-detail-item"><label>Contract #</label><div class="value">${esc(job.contract_number||'‚Äî')}</div></div>
                    <div class="job-detail-item"><label>PO #</label><div class="value">${esc(job.po_number||'‚Äî')}</div></div>
                    <div class="job-detail-item"><label>Address</label><div class="value">${esc(job.address_street||'‚Äî')}</div></div>
                    <div class="job-detail-item"><label>City / State</label><div class="value">${esc(job.address_city||'')} ${esc(job.address_state||'')} ${esc(job.address_zip||'')}</div></div>
                    <div class="job-detail-item"><label>Customer</label><div class="value">${esc(job.customer_name||'‚Äî')}</div></div>
                    <div class="job-detail-item"><label>Contact</label><div class="value">${esc(job.contact_name||'‚Äî')} ${esc(job.contact_phone||'')}</div></div>
                    <div class="job-detail-item"><label>Priority</label><div class="value" style="text-transform:capitalize">${job.priority||'normal'}</div></div>
                    <div class="job-detail-item"><label>Created</label><div class="value">${job.created_at ? new Date(job.created_at).toLocaleString() : '‚Äî'}</div></div>
                </div>`;

            if (job.instructions) {
                html += `<div style="margin-top:12px"><label class="form-label">Instructions</label><p style="font-size:14px;color:var(--text-secondary)">${esc(job.instructions)}</p></div>`;
            }

            html += equipHtml;
            html += historyHtml;

            // Show audit log for admin
            if (currentUser.role === 'admin' || currentUser.role === 'vendor') {
                try {
                    const { data: logs } = await GasRush.db().from('audit_logs').select('*')
                        .eq('target_type', 'job').eq('target_id', id)
                        .order('created_at', { ascending: false }).limit(20);
                    if (logs && logs.length) {
                        html += `<div style="margin-top:16px"><label class="form-label" style="font-size:13px;color:var(--primary)">üìã Change Log</label>
                            <div style="margin-top:6px;max-height:200px;overflow-y:auto">
                            ${logs.map(l => {
                                const t = new Date(l.created_at).toLocaleString();
                                const d = l.details || {};
                                let desc = l.action;
                                if (l.action === 'status_change') desc = `Status: ${d.from} ‚Üí ${d.to}`;
                                else if (l.action === 'assign_worker') desc = `Assigned to ${d.worker_name}`;
                                return `<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:12px"><span style="color:var(--text-muted)">${t}</span> ‚Äî <strong>${esc(l.user_name||'System')}</strong>: ${desc}</div>`;
                            }).join('')}
                            </div></div>`;
                    }
                } catch(e) { console.warn('Audit log load error:', e); }
            }

            // Role-based actions
            html += '<div class="actions-bar">';

            if (currentUser.role === 'vendor' || currentUser.role === 'admin') {
                if (status === 'pending') {
                    html += `<button class="btn btn-primary" onclick="updateJobStatus('${id}','assigned')">‚úÖ Accept Job</button>`;
                }
                if (['pending','assigned'].includes(status)) {
                    html += `<button class="btn btn-secondary" onclick="assignWorker('${id}')">üë∑ Assign Worker</button>`;
                }
            }

            if (currentUser.role === 'fieldworker' || currentUser.role === 'admin') {
                if (['assigned','active'].includes(status)) {
                    html += `<button class="btn btn-primary" onclick="updateJobStatus('${id}','active')">üöõ Start Job</button>`;
                    html += `<button class="btn btn-success" onclick="completeJob('${id}')">‚úÖ Complete Job</button>`;
                }
            }

            if (currentUser.role === 'rental' && status === 'pending') {
                html += `<button class="btn btn-danger" onclick="updateJobStatus('${id}','cancelled')" style="margin-left:auto">Cancel Order</button>`;
            }

            // Edit Job (vendor/admin can change status back)
            if (currentUser.role === 'vendor' || currentUser.role === 'admin') {
                html += `<button class="btn btn-secondary" onclick="editJobStatus('${id}','${status}')">‚úèÔ∏è Edit Status</button>`;
            }

            html += `<button class="btn btn-secondary" onclick="closeModal()" style="margin-left:auto">Close</button>`;
            html += '</div>';

            document.getElementById('modalBody').innerHTML = html;
            modal.classList.add('active');
        }

        function editJobStatus(id, currentStatus) {
            const statuses = ['pending', 'assigned', 'active', 'in-progress', 'completed', 'cancelled'];
            let html = `<div style="padding:8px 0"><p style="margin-bottom:12px;color:var(--text-secondary)">Change job status:</p>`;
            html += statuses.map(s => {
                const selected = s === currentStatus ? 'btn-primary' : 'btn-secondary';
                return `<button class="btn ${selected}" style="margin:4px" onclick="updateJobStatus('${id}','${s}')">${s === currentStatus ? '‚óè ' : ''}${s}</button>`;
            }).join('');
            html += `<div style="margin-top:16px"><button class="btn btn-secondary" onclick="viewJob('${id}')">‚Üê Back</button></div></div>`;
            document.getElementById('modalTitle').textContent = 'Edit Job Status';
            document.getElementById('modalBody').innerHTML = html;
        }

        async function logAudit(jobId, action, details) {
            try {
                await GasRush.db().from('audit_logs').insert({
                    user_id: currentUser.id?.length === 36 ? currentUser.id : null,
                    user_name: currentUser.name || currentUser.email,
                    action: action,
                    target_type: 'job',
                    target_id: jobId,
                    details: details
                });
            } catch(e) { console.warn('Audit log failed:', e); }
        }

        async function updateJobStatus(id, newStatus) {
            try {
                const job = allOrders.find(j => j.id === id);
                const oldStatus = job?.status || 'unknown';
                const update = { status: newStatus };
                if (newStatus === 'assigned') update.assigned_vendor = currentUser.vendor_id || currentUser.id;
                if (newStatus === 'completed') update.completed_at = new Date().toISOString();
                if (newStatus !== 'completed') update.completed_at = null;

                const { error } = await GasRush.db().from('jobs').update(update).eq('id', id);
                if (error) throw error;

                // Log the change
                await logAudit(id, 'status_change', { from: oldStatus, to: newStatus });

                if (job) Object.assign(job, update);
                filterOrders();
                viewJob(id);
            } catch(e) {
                alert('Failed: ' + e.message);
            }
        }

        function completeJob(id) {
            const job = allOrders.find(j => j.id === id);
            const reqFuel = job?.billable_services?.fuelGallons || '';
            const reqDef = job?.billable_services?.defGallons || '';

            let html = `
                <p class="text-muted" style="font-size:14px;margin-bottom:16px">Enter actual delivery data to complete this job:</p>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Diesel Delivered (gal)</label>
                        <input type="number" step="0.1" id="cmpFuel" class="form-input" value="${reqFuel}" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">DEF Delivered (gal)</label>
                        <input type="number" step="0.1" id="cmpDef" class="form-input" value="${reqDef}" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Work Performed / Notes</label>
                    <textarea id="cmpNotes" class="form-textarea" rows="3" placeholder="Describe work performed, equipment status, etc."></textarea>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Field Ticket ID</label>
                        <input type="text" id="cmpTicket" class="form-input" placeholder="FT-001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ticket Type</label>
                        <input type="text" id="cmpTicketType" class="form-input" placeholder="DELIVERY">
                    </div>
                </div>
                <div class="flex gap-2" style="margin-top:16px">
                    <button class="btn btn-success" onclick="submitComplete('${id}')">‚úÖ Complete Job</button>
                    <button class="btn btn-secondary" onclick="viewJob('${id}')">Back</button>
                </div>`;

            document.getElementById('modalTitle').textContent = 'Complete Job ‚Äî ' + (job?.job_site_name || '');
            document.getElementById('modalBody').innerHTML = html;
        }

        async function submitComplete(id) {
            try {
                const job = allOrders.find(j => j.id === id);
                const fuel = parseFloat(document.getElementById('cmpFuel').value) || 0;
                const def = parseFloat(document.getElementById('cmpDef').value) || 0;
                const notes = document.getElementById('cmpNotes').value || null;
                const ticketId = document.getElementById('cmpTicket').value || null;
                const ticketType = document.getElementById('cmpTicketType').value || null;

                const bs = { ...(job?.billable_services || {}), fuelGallons: fuel || null, defGallons: def || null };

                const update = {
                    status: 'completed',
                    completed_at: new Date().toISOString(),
                    billable_services: bs,
                    work_performed: notes,
                    field_ticket_id: ticketId,
                    ticket_type: ticketType,
                    ticket_status: 'COMPLETED'
                };

                const { error } = await GasRush.db().from('jobs').update(update).eq('id', id);
                if (error) throw error;

                // Auto-create invoice
                try {
                    await GasRush.db().from('invoices').insert({
                        job_id: id,
                        vendor_id: job?.assigned_vendor || currentUser.vendor_id,
                        amount: ((fuel * 3.50) + (def * 2.50)).toFixed(2),
                        status: 'pending',
                        created_at: new Date().toISOString(),
                        description: `${job?.job_site_name || 'Job'} ‚Äî ${fuel} gal diesel, ${def} gal DEF`
                    });
                } catch(ie) {
                    console.warn('Invoice creation failed:', ie);
                }

                if (job) Object.assign(job, update);
                filterOrders();
                closeModal();
                alert(`Job completed ‚Äî ${fuel} gal diesel, ${def} gal DEF. Invoice created.`);
            } catch(e) {
                alert('Failed: ' + e.message);
            }
        }

        let cachedWorkers = null;
        async function assignWorker(id) {
            // Load field workers if not cached
            if (!cachedWorkers) {
                try {
                    const { data } = await GasRush.db().from('users').select('id,name,email').eq('role', 'fieldworker');
                    cachedWorkers = data || [];
                } catch(e) { cachedWorkers = []; }
            }

            if (cachedWorkers.length === 0) {
                alert('No field workers found in the system.');
                return;
            }

            // Build a selection modal
            const job = allOrders.find(j => j.id === id);
            let html = '<div style="margin-bottom:16px"><p class="text-muted" style="font-size:14px">Select a field worker to assign to this job:</p></div>';
            html += '<div style="display:flex;flex-direction:column;gap:8px">';
            for (const w of cachedWorkers) {
                html += `<button class="btn btn-secondary" style="justify-content:flex-start;padding:12px 16px" onclick="confirmAssignWorker('${id}','${w.id}','${esc(w.name)}')">
                    <span>üë∑</span>
                    <div style="text-align:left"><div style="font-weight:600">${esc(w.name)}</div><div style="font-size:12px;color:var(--text-muted)">${esc(w.email)}</div></div>
                </button>`;
            }
            html += '</div>';

            document.getElementById('modalTitle').textContent = 'Assign Field Worker';
            document.getElementById('modalBody').innerHTML = html;
        }

        async function confirmAssignWorker(jobId, workerId, workerName) {
            try {
                const { error } = await GasRush.db().from('jobs').update({
                    assigned_worker: workerId,
                    status: 'assigned'
                }).eq('id', jobId);
                if (error) throw error;

                await logAudit(jobId, 'assign_worker', { worker_id: workerId, worker_name: workerName });

                const job = allOrders.find(j => j.id === jobId);
                if (job) { job.assigned_worker = workerId; job.status = 'assigned'; }
                filterOrders();
                viewJob(jobId);
            } catch(e) {
                alert('Failed to assign: ' + e.message);
            }
        }

        function closeModal() {
            document.getElementById('jobModal').classList.remove('active');
        }

        // Close modal on backdrop click
        document.getElementById('jobModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });

        function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    </script>
</body>
</html>
