<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush â€” Vendor Dashboard</title>
    <link rel="stylesheet" href="theme.css">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">â›½</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="page-header flex justify-between items-center">
                <div>
                    <h1>Vendor Dashboard</h1>
                    <p id="greeting">Welcome back</p>
                </div>
                <div class="flex gap-2">
                    <a href="create-job.html" class="btn btn-primary">âž• Create Work Order</a>
                    <button class="btn btn-secondary" onclick="loadData()">ðŸ”„ Refresh</button>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">Assigned Jobs</div>
                    <div class="stat-value" id="statAssigned">â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value" id="statCompleted">â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Gallons</div>
                    <div class="stat-value" id="statGallons">â€”</div>
                    <div class="stat-sub">gal</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Field Workers</div>
                    <div class="stat-value" id="statWorkers">â€”</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Jobs</h2>
                </div>
                <div id="jobsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“‹</div>
                        <h3>Loading...</h3>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px">
                <div class="card-header">
                    <h2 class="card-title">Recent Activity</h2>
                </div>
                <div id="activityContainer">
                    <div class="empty-state"><h3>Loading...</h3></div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let currentUser = null;

        (async () => {
            const user = await GasRush.init({ roles: ['vendor', 'admin'] });
            if (!user) return;
            currentUser = user;

            const hour = new Date().getHours();
            const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
            document.getElementById('greeting').textContent = `${greet}, ${user.name}`;

            await loadData();
        })();

        async function loadData() {
            try {
                let query = GasRush.db().from('jobs').select('*').order('created_at', { ascending: false });

                if (currentUser.role === 'vendor' && currentUser.vendor_id) {
                    query = query.or(`assigned_vendor.eq.${currentUser.vendor_id},status.eq.pending,assigned_vendor.is.null`);
                }

                const { data: jobs, error } = await query;
                if (error) throw error;
                const all = jobs || [];

                const assigned = all.filter(j => ['pending', 'active', 'assigned'].includes(j.status)).length;
                const completed = all.filter(j => j.status === 'completed').length;
                const gallons = all.reduce((s, j) => s + (parseFloat(j.billable_services?.fuelGallons || 0)), 0);
                const workers = new Set(all.filter(j => j.assigned_worker).map(j => j.assigned_worker)).size;

                document.getElementById('statAssigned').textContent = assigned;
                document.getElementById('statCompleted').textContent = completed;
                document.getElementById('statGallons').textContent = gallons.toLocaleString();
                document.getElementById('statWorkers').textContent = workers;

                renderJobs(all.slice(0, 20));

                // Load recent activity from audit_logs for this vendor's jobs
                const jobIds = all.map(j => j.id);
                if (jobIds.length > 0) {
                    const { data: logs } = await GasRush.db()
                        .from('audit_logs')
                        .select('*')
                        .eq('target_type', 'job')
                        .in('target_id', jobIds)
                        .order('created_at', { ascending: false })
                        .limit(20);
                    renderActivity(logs || []);
                } else {
                    renderActivity([]);
                }
            } catch(e) {
                console.error('Failed to load:', e);
                renderJobs([]);
                renderActivity([]);
            }
        }

        function renderActivity(logs) {
            const c = document.getElementById('activityContainer');
            if (!logs.length) {
                c.innerHTML = '<div class="empty-state"><h3>No recent activity</h3></div>';
                return;
            }
            let html = '<div style="padding:16px;display:flex;flex-direction:column;gap:10px">';
            for (const log of logs) {
                const dt = log.created_at ? new Date(log.created_at).toLocaleString() : '';
                const name = log.user_name || 'Unknown';
                const action = (log.action || '').replace(/_/g, ' ');
                const detail = log.details ? formatDetail(log.details) : '';
                html += `<div style="font-size:14px;color:var(--text-secondary);border-bottom:1px solid var(--border);padding-bottom:8px">
                    <span style="color:var(--text-muted);font-size:12px">${dt}</span> â€” <strong>${esc(name)}</strong>: ${esc(action)}${detail ? ' <span style="color:var(--text-muted)">' + esc(detail) + '</span>' : ''}
                </div>`;
            }
            html += '</div>';
            c.innerHTML = html;
        }

        function formatDetail(details) {
            if (typeof details === 'string') try { details = JSON.parse(details); } catch(e) { return details; }
            if (details.old_status && details.new_status) return `${details.old_status} â†’ ${details.new_status}`;
            if (details.job_site) return details.job_site;
            return '';
        }

        function renderJobs(jobs) {
            const container = document.getElementById('jobsContainer');
            if (jobs.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><h3>No jobs yet</h3></div>`;
                return;
            }

            let html = '<div class="table-wrapper"><table><thead><tr>';
            html += '<th>Date</th><th>Job</th><th class="hide-mobile">Location</th><th>Status</th><th class="hide-mobile">Gallons</th>';
            html += '</tr></thead><tbody>';

            for (const job of jobs) {
                const date = job.created_at ? new Date(job.created_at).toLocaleDateString() : 'â€”';
                const name = job.job_site_name || 'Untitled';
                const loc = job.address_city || 'â€”';
                const gal = job.billable_services?.fuelGallons || 'â€”';
                const status = job.status || 'pending';
                const bc = status === 'completed' ? 'badge-success' : ['active','assigned'].includes(status) ? 'badge-primary' : 'badge-warning';
                html += `<tr><td>${date}</td><td><strong>${esc(name)}</strong></td><td class="hide-mobile">${esc(loc)}</td><td><span class="badge ${bc}">${status}</span></td><td class="hide-mobile">${gal}</td></tr>`;
            }
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    </script>
</body>
</html>
