<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush ‚Äî Job Site Detail</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .back-link { display:inline-flex; align-items:center; gap:6px; font-size:14px; color:var(--text-secondary); margin-bottom:16px; }
        .back-link:hover { color:var(--primary); }
        .site-header-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:24px; margin-bottom:24px; }
        .site-title { font-size:24px; font-weight:700; margin-bottom:4px; }
        .site-address { font-size:14px; color:var(--text-secondary); }
        .timeline { margin-top:8px; }
        .timeline-item {
            display:flex; gap:16px; padding:16px 0; border-bottom:1px solid var(--border-light);
            position:relative;
        }
        .timeline-item:last-child { border-bottom:none; }
        .timeline-date {
            min-width:100px; font-size:13px; color:var(--text-muted); font-weight:600; padding-top:2px;
        }
        .timeline-content { flex:1; }
        .timeline-type { font-size:14px; font-weight:600; color:var(--text-primary); text-transform:capitalize; margin-bottom:4px; }
        .timeline-details { font-size:13px; color:var(--text-secondary); line-height:1.6; }
        .timeline-details span { display:inline-block; margin-right:16px; }
        .fuel-tag { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:600; }
        .fuel-tag.diesel { background:var(--warning-light); color:var(--warning); }
        .fuel-tag.def { background:var(--primary-light); color:var(--primary); }
        .equip-list { margin-top:8px; }
        .equip-item { font-size:12px; color:var(--text-muted); padding:2px 0; }
        .filter-row { display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; align-items:center; }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">‚õΩ</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="flex justify-between items-center" style="margin-bottom:16px">
                <a href="job-sites.html" class="back-link" style="margin:0">‚Üê Back to Job Sites</a>
                <button class="btn btn-primary" onclick="exportExcel()">üì• Export to Excel</button>
            </div>

            <div class="site-header-card" id="siteHeader">
                <div class="empty-state"><h3>Loading...</h3></div>
            </div>

            <!-- Equipment at this site -->
            <div class="card" id="equipSection" style="display:none">
                <div class="card-header">
                    <h2 class="card-title">Equipment at this Site</h2>
                </div>
                <div id="equipList"></div>
            </div>

            <!-- Delivery History -->
            <div class="card mt-4" id="deliverySection" style="display:none">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                    <h2 class="card-title">Delivery History</h2>
                    <div style="display:flex;gap:8px;align-items:center">
                        <input type="date" id="deliveryDateFilter" class="form-input" style="width:160px;padding:8px" onchange="renderDeliveries()">
                        <button class="btn btn-secondary" style="padding:8px 12px;font-size:13px" onclick="document.getElementById('deliveryDateFilter').value='';renderDeliveries()">All</button>
                    </div>
                </div>
                <div id="deliveryList"></div>
            </div>

            <!-- Job/Work Order Details -->
            <div class="card mt-4" id="jobDetailsSection" style="display:none">
                <div class="card-header">
                    <h2 class="card-title">Work Order Details</h2>
                </div>
                <div id="jobDetailsBody"></div>
            </div>
        </main>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let allJobs = [];
        let siteEquip = [];
        let siteDeliveries = [];
        const siteName = new URLSearchParams(window.location.search).get('site');

        (async () => {
            const user = await GasRush.init({ roles: ['rental', 'vendor', 'fieldworker', 'admin'] });
            if (!user) return;
            if (!siteName) { window.location.href = 'job-sites.html'; return; }
            document.title = `GasRush ‚Äî ${siteName}`;
            await loadData();
        })();

        async function loadData() {
            try {
                const { data: jobs, error } = await GasRush.db()
                    .from('jobs')
                    .select('*')
                    .eq('job_site_name', siteName)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                allJobs = jobs || [];

                // Load equipment for all job IDs at this site
                const jobIds = allJobs.map(j => j.id);
                if (jobIds.length) {
                    const { data: equip } = await GasRush.db()
                        .from('equipment')
                        .select('*')
                        .in('job_id', jobIds);
                    siteEquip = equip || [];
                }

                // Load deliveries for all jobs at this site
                if (jobIds.length) {
                    const { data: dels } = await GasRush.db()
                        .from('deliveries')
                        .select('*')
                        .in('job_id', jobIds)
                        .order('timestamp', { ascending: false });
                    siteDeliveries = dels || [];
                }

                renderHeader();
                renderEquipment();
                renderDeliveries();
                renderJobDetails();
            } catch(e) {
                console.error(e);
                document.getElementById('siteHeader').innerHTML = '<div class="empty-state"><h3>Failed to load site data</h3></div>';
            }
        }

        function renderHeader() {
            const first = allJobs[0] || {};
            const addr = [first.address_street, first.address_city, first.address_state, first.address_zip].filter(Boolean).join(', ');
            document.getElementById('siteHeader').innerHTML = `
                <div class="site-title">${esc(siteName)}</div>
                <div class="site-address">üìç ${esc(addr || 'No address on file')}</div>
                ${first.customer_name ? `<div style="font-size:14px;color:var(--text-secondary);margin-top:4px">Customer: <strong>${esc(first.customer_name)}</strong></div>` : ''}
                ${first.contact_name ? `<div style="font-size:13px;color:var(--text-muted)">Contact: ${esc(first.contact_name)} ${esc(first.contact_phone || '')}</div>` : ''}
            `;
        }

        function getFilteredDeliveries() {
            const dateVal = document.getElementById('deliveryDateFilter')?.value;
            if (!dateVal) return siteDeliveries;
            return siteDeliveries.filter(d => d.timestamp && d.timestamp.startsWith(dateVal));
        }

        function renderDeliveries() {
            if (!siteDeliveries.length) return;
            document.getElementById('deliverySection').style.display = '';
            const filtered = getFilteredDeliveries();
            const list = document.getElementById('deliveryList');
            if (!filtered.length) {
                list.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted)">No deliveries for selected date</div>';
                return;
            }
            let h = `<div style="display:flex;gap:8px;margin-bottom:8px">
                <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="toggleAllDeliveries()">Select All</button>
                <button class="btn btn-primary" style="padding:6px 12px;font-size:12px" onclick="exportSelected()">üì• Export Selected</button>
            </div>`;
            h += '<div class="table-wrapper"><table><thead><tr><th style="width:32px"><input type="checkbox" id="selectAllCb" onchange="toggleAllDeliveries(this.checked)"></th><th>Date</th><th>Driver</th><th>Unit #</th><th>Diesel</th><th>DEF</th><th>Gen Hours</th></tr></thead><tbody>';
            filtered.forEach((d, i) => {
                const date = d.timestamp ? new Date(d.timestamp).toLocaleString() : '‚Äî';
                h += `<tr>
                    <td><input type="checkbox" class="del-cb" data-idx="${i}" value="${d.id}"></td>
                    <td>${date}</td>
                    <td>${esc(d.delivered_by_name || '‚Äî')}</td>
                    <td><strong>${esc(d.unit_number || '‚Äî')}</strong></td>
                    <td>${d.gallons || 0} gal</td>
                    <td>${d.def_gallons || 0} gal</td>
                    <td>${d.unit_hours || '‚Äî'}</td>
                </tr>`;
            });
            h += '</tbody></table></div>';
            list.innerHTML = h;
        }

        function toggleAllDeliveries(checked) {
            const cbs = document.querySelectorAll('.del-cb');
            const allCb = document.getElementById('selectAllCb');
            if (checked === undefined) {
                // Toggle: if all checked, uncheck all; else check all
                const allChecked = [...cbs].every(c => c.checked);
                cbs.forEach(c => c.checked = !allChecked);
                if (allCb) allCb.checked = !allChecked;
            } else {
                cbs.forEach(c => c.checked = checked);
            }
        }

        function exportSelected() {
            const filtered = getFilteredDeliveries();
            const selected = [...document.querySelectorAll('.del-cb:checked')].map(c => c.value);
            if (!selected.length) { alert('Select at least one delivery to export.'); return; }

            const exportDels = filtered.filter(d => selected.includes(d.id));
            const totalDiesel = exportDels.reduce((s, d) => s + (parseFloat(d.gallons) || 0), 0);
            const totalDef = exportDels.reduce((s, d) => s + (parseFloat(d.def_gallons) || 0), 0);
            const first = allJobs[0] || {};
            const addr = [first.address_street, first.address_city, first.address_state, first.address_zip].filter(Boolean).join(', ');

            const wb = XLSX.utils.book_new();

            // Summary
            const summary = [
                ['', '', siteName],
                [],
                ['Site Information'],
                ['Address', addr],
                ['Customer', first.customer_name || ''],
                ['Contact', first.contact_name || ''],
                ['Phone', first.contact_phone || ''],
                ['Contract #', first.contract_number || ''],
                ['PO #', first.po_number || ''],
                [],
                ['Export Summary'],
                ['Deliveries Selected', exportDels.length],
                ['Total Diesel (gal)', totalDiesel],
                ['Total DEF (gal)', totalDef],
                [],
                ['Report Generated', new Date().toLocaleString()],
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summary);
            ws1['!cols'] = [{ wch: 22 }, { wch: 45 }, { wch: 30 }];
            XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

            // Deliveries
            const delData = [['Date', 'Time', 'Driver', 'Unit #', 'Diesel (gal)', 'DEF (gal)', 'Gen Hours', 'Notes']];
            exportDels.forEach(d => {
                const dt = d.timestamp ? new Date(d.timestamp) : null;
                delData.push([
                    dt ? dt.toLocaleDateString() : '',
                    dt ? dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
                    d.delivered_by_name || '',
                    d.unit_number || '',
                    parseFloat(d.gallons) || 0,
                    parseFloat(d.def_gallons) || 0,
                    d.unit_hours || '',
                    d.notes || ''
                ]);
            });
            delData.push([]);
            delData.push(['', '', '', 'TOTALS', totalDiesel, totalDef, '', '']);
            const ws2 = XLSX.utils.aoa_to_sheet(delData);
            ws2['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 18 }, { wch: 14 }, { wch: 14 }, { wch: 12 }, { wch: 12 }, { wch: 30 }];
            XLSX.utils.book_append_sheet(wb, ws2, 'Deliveries');

            const filename = siteName.replace(/[^a-zA-Z0-9]/g, '_') + '_selected_deliveries.xlsx';
            XLSX.writeFile(wb, filename);
        }

        function renderJobDetails() {
            if (!allJobs.length) return;
            const j = allJobs[0]; // most recent job at this site
            document.getElementById('jobDetailsSection').style.display = '';

            const field = (label, val) => val ? `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text-muted);font-size:13px">${label}</span><span style="font-size:14px;font-weight:500;text-align:right">${esc(val)}</span></div>` : '';
            const genInfo = j.generator_info || {};

            let html = '<div>';
            html += field('Job Type', (j.job_type || '').replace('-', ' '));
            html += field('Status', j.status);
            html += field('Contract #', j.contract_number);
            html += field('PO #', j.po_number);
            html += field('Job #', j.job_number);
            html += field('Order ID', j.order_id);
            html += field('Customer #', j.customer_number);
            html += field('Vendor #', j.vendor_number);
            html += field('Payment Terms', j.payment_terms);
            html += field('Salesman', j.salesman);
            html += field('Rental Company', j.rental_company);
            html += field('Date Out', j.date_out);
            html += field('Time Out', j.time_out);
            html += field('Est. Return', j.est_return);
            html += field('Document Source', j.document_source);
            html += '</div>';

            // Field Ticket
            if (j.field_ticket_id || j.ticket_type || j.area || j.work_performed) {
                html += '<h3 style="margin-top:16px;font-size:14px;color:var(--primary)">Field Ticket</h3><div>';
                html += field('Ticket ID', j.field_ticket_id);
                html += field('Ticket Type', j.ticket_type);
                html += field('Area', j.area);
                html += field('Ticket Status', j.ticket_status);
                html += field('Technician', j.technician_name);
                html += '</div>';
                if (j.work_performed) html += `<div style="margin-top:8px"><label style="font-size:12px;color:var(--text-muted)">Work Performed</label><p style="font-size:14px;color:var(--text-secondary);white-space:pre-wrap">${esc(j.work_performed)}</p></div>`;
            }

            // Generator Info
            if (j.old_gen_hour || j.new_gen_id || j.new_gen_hour || Object.keys(genInfo).length) {
                html += '<h3 style="margin-top:16px;font-size:14px;color:var(--primary)">Generator Info</h3><div>';
                html += field('Old Gen Hours', j.old_gen_hour);
                html += field('New Gen ID', j.new_gen_id);
                html += field('New Gen Hours', j.new_gen_hour);
                Object.entries(genInfo).forEach(([k, v]) => { if (v) html += field(k.replace(/_/g, ' '), String(v)); });
                html += '</div>';
            }

            // Instructions
            if (j.instructions) {
                html += `<div style="margin-top:16px"><label style="font-size:12px;color:var(--text-muted)">Instructions</label><p style="font-size:14px;color:var(--text-secondary);white-space:pre-wrap">${esc(j.instructions)}</p></div>`;
            }

            document.getElementById('jobDetailsBody').innerHTML = html;
        }

        function renderEquipment() {
            if (!siteEquip.length) return;
            document.getElementById('equipSection').style.display = '';

            // Deduplicate by equipment_number and sum delivery totals
            const unique = {};
            for (const e of siteEquip) {
                const key = e.equipment_number || e.description || e.id;
                if (!unique[key]) unique[key] = { ...e, count: 0, totalDiesel: 0, totalDef: 0, lastHours: null };
            }
            // Sum deliveries per unit
            for (const d of siteDeliveries) {
                const key = d.unit_number;
                if (key && unique[key]) {
                    unique[key].count++;
                    unique[key].totalDiesel += parseFloat(d.gallons) || 0;
                    unique[key].totalDef += parseFloat(d.def_gallons) || 0;
                    const hrs = parseFloat(d.unit_hours) || 0;
                    if (hrs && (!unique[key].lastHours || hrs > unique[key].lastHours)) unique[key].lastHours = hrs;
                } else if (key) {
                    // Delivery for unit not in equipment table
                    unique[key] = { equipment_number: key, description: '', count: 1, totalDiesel: parseFloat(d.gallons) || 0, totalDef: parseFloat(d.def_gallons) || 0, lastHours: parseFloat(d.unit_hours) || null };
                }
            }

            document.getElementById('equipList').innerHTML = '<div class="table-wrapper"><table><thead><tr><th>QTY</th><th>Unit #</th><th>Description</th><th>Deliveries</th><th>Total Diesel</th><th>Total DEF</th><th>Last Gen Hrs</th></tr></thead><tbody>' +
                Object.values(unique).map(e => `<tr>
                    <td>${e.quantity || 1}</td>
                    <td><strong>${esc(e.equipment_number || '‚Äî')}</strong></td>
                    <td>${esc(e.description || '‚Äî')}</td>
                    <td>${e.count}</td>
                    <td>${e.totalDiesel ? e.totalDiesel.toLocaleString() + ' gal' : '‚Äî'}</td>
                    <td>${e.totalDef ? e.totalDef.toLocaleString() + ' gal' : '‚Äî'}</td>
                    <td>${e.lastHours || '‚Äî'}</td>
                </tr>`).join('') + '</tbody></table></div>';
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            const first = allJobs[0] || {};
            const addr = [first.address_street, first.address_city, first.address_state, first.address_zip].filter(Boolean).join(', ');
            const exportDeliveries = getFilteredDeliveries();

            // Build rows: Header info rows 1-4, then column headers, then delivery data
            const rows = [];

            // Row 1: CUSTOMER NAME header + column headers
            rows.push(['CUSTOMER NAME', 'INVOICE NUMBER', 'DATE', 'RD99 DIESEL RATE', 'RD99 DIESEL GALLONS', 'DEF RATE', 'DEF GALLONS', 'DELIVERY', 'TOTAL']);
            // Row 2: ADDRESS
            rows.push(['ADDRESS']);
            // Row 3: UNIT #
            rows.push(['UNIT #']);
            // Row 4: PO#
            rows.push(['PO#']);

            // Blank separator row
            rows.push([]);

            // One row per delivery, grouped by unit
            const unitDeliveries = {};
            for (const d of exportDeliveries) {
                const unit = d.unit_number || 'Unknown';
                if (!unitDeliveries[unit]) unitDeliveries[unit] = [];
                unitDeliveries[unit].push(d);
            }

            for (const [unit, dels] of Object.entries(unitDeliveries)) {
                for (let i = 0; i < dels.length; i++) {
                    const d = dels[i];
                    const dt = d.timestamp ? new Date(d.timestamp) : null;
                    const diesel = parseFloat(d.gallons) || 0;
                    const def = parseFloat(d.def_gallons) || 0;
                    const row = [
                        i === 0 ? (first.customer_name || '') : '',  // Customer name on first row per unit
                        '',  // Invoice number (fill manually or from invoices)
                        dt ? dt.toLocaleDateString() : '',
                        '',  // RD99 diesel rate (fill manually)
                        diesel || '',
                        '',  // DEF rate (fill manually)
                        def || '',
                        i === 0 ? (d.delivered_by_name || '') : '',  // Driver
                        ''   // Total (formula or manual)
                    ];
                    // Fill address/unit/PO on first row
                    if (i === 0) {
                        row[0] = first.customer_name || '';
                    }
                    rows.push(row);
                }
                // After each unit group, add a blank row
                rows.push([]);
            }

            // Now fill in rows 2-4 column A values with actual data
            if (rows.length > 1) rows[1][0] = addr;
            // Fill unit # for each unit group
            let unitList = Object.keys(unitDeliveries).join(', ');
            if (rows.length > 2) rows[2][0] = unitList;
            if (rows.length > 3) rows[3][0] = first.po_number || '';

            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!cols'] = [
                { wch: 28 },  // A: Customer Name
                { wch: 18 },  // B: Invoice Number
                { wch: 12 },  // C: Date
                { wch: 18 },  // D: RD99 Diesel Rate
                { wch: 22 },  // E: RD99 Diesel Gallons
                { wch: 12 },  // F: DEF Rate
                { wch: 14 },  // G: DEF Gallons
                { wch: 14 },  // H: Delivery
                { wch: 10 },  // I: Total
            ];
            XLSX.utils.book_append_sheet(wb, ws, 'Invoice');

            const filename = siteName.replace(/[^a-zA-Z0-9]/g, '_') + '_invoice.xlsx';
            XLSX.writeFile(wb, filename);
        }

        function esc(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    </script>
</body>
</html>
