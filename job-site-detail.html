<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush ‚Äî Job Site Detail</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .back-link { display:inline-flex; align-items:center; gap:6px; font-size:14px; color:var(--text-secondary); margin-bottom:16px; }
        .back-link:hover { color:var(--primary); }
        .site-header-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:24px; margin-bottom:24px; }
        .site-title { font-size:24px; font-weight:700; margin-bottom:4px; }
        .site-address { font-size:14px; color:var(--text-secondary); }
        .timeline { margin-top:8px; }
        .timeline-item {
            display:flex; gap:16px; padding:16px 0; border-bottom:1px solid var(--border-light);
            position:relative;
        }
        .timeline-item:last-child { border-bottom:none; }
        .timeline-date {
            min-width:100px; font-size:13px; color:var(--text-muted); font-weight:600; padding-top:2px;
        }
        .timeline-content { flex:1; }
        .timeline-type { font-size:14px; font-weight:600; color:var(--text-primary); text-transform:capitalize; margin-bottom:4px; }
        .timeline-details { font-size:13px; color:var(--text-secondary); line-height:1.6; }
        .timeline-details span { display:inline-block; margin-right:16px; }
        .fuel-tag { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:600; }
        .fuel-tag.diesel { background:var(--warning-light); color:var(--warning); }
        .fuel-tag.def { background:var(--primary-light); color:var(--primary); }
        .equip-list { margin-top:8px; }
        .equip-item { font-size:12px; color:var(--text-muted); padding:2px 0; }
        .filter-row { display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; align-items:center; }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">‚õΩ</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="flex justify-between items-center" style="margin-bottom:16px">
                <a href="job-sites.html" class="back-link" style="margin:0">‚Üê Back to Job Sites</a>
                <button class="btn btn-primary" onclick="exportExcel()">üì• Export to Excel</button>
            </div>

            <div class="site-header-card" id="siteHeader">
                <div class="empty-state"><h3>Loading...</h3></div>
            </div>

            <!-- Equipment at this site -->
            <div class="card" id="equipSection" style="display:none">
                <div class="card-header">
                    <h2 class="card-title">Equipment at this Site</h2>
                </div>
                <div id="equipList"></div>
            </div>

            <!-- Delivery History -->
            <div class="card mt-4" id="deliverySection" style="display:none">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                    <h2 class="card-title">Delivery History</h2>
                    <div style="display:flex;gap:8px;align-items:center">
                        <input type="date" id="deliveryDateFilter" class="form-input" style="width:160px;padding:8px" onchange="renderDeliveries()">
                        <button class="btn btn-secondary" style="padding:8px 12px;font-size:13px" onclick="document.getElementById('deliveryDateFilter').value='';renderDeliveries()">All</button>
                    </div>
                </div>
                <div id="deliveryList"></div>
            </div>

            <!-- Job/Work Order Details -->
            <div class="card mt-4" id="jobDetailsSection" style="display:none">
                <div class="card-header">
                    <h2 class="card-title">Work Order Details</h2>
                </div>
                <div id="jobDetailsBody"></div>
            </div>
        </main>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let allJobs = [];
        let siteEquip = [];
        let siteDeliveries = [];
        const siteName = new URLSearchParams(window.location.search).get('site');

        (async () => {
            const user = await GasRush.init({ roles: ['rental', 'vendor', 'fieldworker', 'admin'] });
            if (!user) return;
            if (!siteName) { window.location.href = 'job-sites.html'; return; }
            document.title = `GasRush ‚Äî ${siteName}`;
            await loadData();
        })();

        async function loadData() {
            try {
                const { data: jobs, error } = await GasRush.db()
                    .from('jobs')
                    .select('*')
                    .eq('job_site_name', siteName)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                allJobs = jobs || [];

                // Load equipment for all job IDs at this site
                const jobIds = allJobs.map(j => j.id);
                if (jobIds.length) {
                    const { data: equip } = await GasRush.db()
                        .from('equipment')
                        .select('*')
                        .in('job_id', jobIds);
                    siteEquip = equip || [];
                }

                // Load deliveries for all jobs at this site
                if (jobIds.length) {
                    const { data: dels } = await GasRush.db()
                        .from('deliveries')
                        .select('*')
                        .in('job_id', jobIds)
                        .order('timestamp', { ascending: false });
                    siteDeliveries = dels || [];
                }

                renderHeader();
                renderEquipment();
                renderDeliveries();
                renderJobDetails();
            } catch(e) {
                console.error(e);
                document.getElementById('siteHeader').innerHTML = '<div class="empty-state"><h3>Failed to load site data</h3></div>';
            }
        }

        function renderHeader() {
            const first = allJobs[0] || {};
            const addr = [first.address_street, first.address_city, first.address_state, first.address_zip].filter(Boolean).join(', ');
            document.getElementById('siteHeader').innerHTML = `
                <div class="site-title">${esc(siteName)}</div>
                <div class="site-address">üìç ${esc(addr || 'No address on file')}</div>
                ${first.customer_name ? `<div style="font-size:14px;color:var(--text-secondary);margin-top:4px">Customer: <strong>${esc(first.customer_name)}</strong></div>` : ''}
                ${first.contact_name ? `<div style="font-size:13px;color:var(--text-muted)">Contact: ${esc(first.contact_name)} ${esc(first.contact_phone || '')}</div>` : ''}
            `;
        }

        function renderStats() {
            const total = allJobs.length;
            const completed = allJobs.filter(j => j.status === 'completed').length;
            const fuel = allJobs.reduce((s, j) => s + (parseFloat(j.billable_services?.fuelGallons) || 0), 0);
            const def = allJobs.reduce((s, j) => s + (parseFloat(j.billable_services?.defGallons) || 0), 0);
            const firstDate = allJobs.length ? new Date(allJobs[allJobs.length - 1].created_at).toLocaleDateString() : '‚Äî';
            const lastDate = allJobs.length ? new Date(allJobs[0].created_at).toLocaleDateString() : '‚Äî';

            document.getElementById('siteStats').innerHTML = `
                <div class="stat-card"><div class="stat-label">Total Jobs</div><div class="stat-value">${total}</div></div>
                <div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value">${completed}</div></div>
                <div class="stat-card"><div class="stat-label">Total Fuel</div><div class="stat-value">${fuel.toLocaleString()}</div><div class="stat-sub">gallons diesel</div></div>
                <div class="stat-card"><div class="stat-label">Total DEF</div><div class="stat-value">${def.toLocaleString()}</div><div class="stat-sub">gallons</div></div>
                <div class="stat-card"><div class="stat-label">First Job</div><div class="stat-value" style="font-size:16px">${firstDate}</div></div>
                <div class="stat-card"><div class="stat-label">Latest Job</div><div class="stat-value" style="font-size:16px">${lastDate}</div></div>
            `;
        }

        function getFilteredDeliveries() {
            const dateVal = document.getElementById('deliveryDateFilter')?.value;
            if (!dateVal) return siteDeliveries;
            return siteDeliveries.filter(d => d.timestamp && d.timestamp.startsWith(dateVal));
        }

        function renderDeliveries() {
            if (!siteDeliveries.length) return;
            document.getElementById('deliverySection').style.display = '';
            const filtered = getFilteredDeliveries();
            const list = document.getElementById('deliveryList');
            if (!filtered.length) {
                list.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted)">No deliveries for selected date</div>';
                return;
            }
            let h = '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Driver</th><th>Unit #</th><th>Diesel</th><th>DEF</th><th>Gen Hours</th></tr></thead><tbody>';
            filtered.forEach(d => {
                const date = d.timestamp ? new Date(d.timestamp).toLocaleString() : '‚Äî';
                h += `<tr>
                    <td>${date}</td>
                    <td>${esc(d.delivered_by_name || '‚Äî')}</td>
                    <td><strong>${esc(d.unit_number || '‚Äî')}</strong></td>
                    <td>${d.gallons || 0} gal</td>
                    <td>${d.def_gallons || 0} gal</td>
                    <td>${d.unit_hours || '‚Äî'}</td>
                </tr>`;
            });
            h += '</tbody></table></div>';
            list.innerHTML = h;
        }

        function renderJobDetails() {
            if (!allJobs.length) return;
            const j = allJobs[0]; // most recent job at this site
            document.getElementById('jobDetailsSection').style.display = '';

            const field = (label, val) => val ? `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text-muted);font-size:13px">${label}</span><span style="font-size:14px;font-weight:500;text-align:right">${esc(val)}</span></div>` : '';
            const genInfo = j.generator_info || {};

            let html = '<div>';
            html += field('Job Type', (j.job_type || '').replace('-', ' '));
            html += field('Status', j.status);
            html += field('Contract #', j.contract_number);
            html += field('PO #', j.po_number);
            html += field('Job #', j.job_number);
            html += field('Order ID', j.order_id);
            html += field('Customer #', j.customer_number);
            html += field('Vendor #', j.vendor_number);
            html += field('Payment Terms', j.payment_terms);
            html += field('Salesman', j.salesman);
            html += field('Rental Company', j.rental_company);
            html += field('Date Out', j.date_out);
            html += field('Time Out', j.time_out);
            html += field('Est. Return', j.est_return);
            html += field('Document Source', j.document_source);
            html += '</div>';

            // Field Ticket
            if (j.field_ticket_id || j.ticket_type || j.area || j.work_performed) {
                html += '<h3 style="margin-top:16px;font-size:14px;color:var(--primary)">Field Ticket</h3><div>';
                html += field('Ticket ID', j.field_ticket_id);
                html += field('Ticket Type', j.ticket_type);
                html += field('Area', j.area);
                html += field('Ticket Status', j.ticket_status);
                html += field('Technician', j.technician_name);
                html += '</div>';
                if (j.work_performed) html += `<div style="margin-top:8px"><label style="font-size:12px;color:var(--text-muted)">Work Performed</label><p style="font-size:14px;color:var(--text-secondary);white-space:pre-wrap">${esc(j.work_performed)}</p></div>`;
            }

            // Generator Info
            if (j.old_gen_hour || j.new_gen_id || j.new_gen_hour || Object.keys(genInfo).length) {
                html += '<h3 style="margin-top:16px;font-size:14px;color:var(--primary)">Generator Info</h3><div>';
                html += field('Old Gen Hours', j.old_gen_hour);
                html += field('New Gen ID', j.new_gen_id);
                html += field('New Gen Hours', j.new_gen_hour);
                Object.entries(genInfo).forEach(([k, v]) => { if (v) html += field(k.replace(/_/g, ' '), String(v)); });
                html += '</div>';
            }

            // Instructions
            if (j.instructions) {
                html += `<div style="margin-top:16px"><label style="font-size:12px;color:var(--text-muted)">Instructions</label><p style="font-size:14px;color:var(--text-secondary);white-space:pre-wrap">${esc(j.instructions)}</p></div>`;
            }

            document.getElementById('jobDetailsBody').innerHTML = html;
        }

        function renderEquipment() {
            if (!siteEquip.length) return;
            document.getElementById('equipSection').style.display = '';

            // Deduplicate by equipment_number
            const unique = {};
            for (const e of siteEquip) {
                const key = e.equipment_number || e.description || e.id;
                if (!unique[key]) unique[key] = { ...e, count: 0 };
                unique[key].count++;
            }

            document.getElementById('equipList').innerHTML = '<div class="table-wrapper"><table><thead><tr><th>Unit #</th><th>Description</th><th>Times Serviced</th></tr></thead><tbody>' +
                Object.values(unique).map(e => `<tr>
                    <td><strong>${esc(e.equipment_number || '‚Äî')}</strong></td>
                    <td>${esc(e.description || '‚Äî')}</td>
                    <td>${e.count}</td>
                </tr>`).join('') + '</tbody></table></div>';
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            const first = allJobs[0] || {};
            const addr = [first.address_street, first.address_city, first.address_state, first.address_zip].filter(Boolean).join(', ');

            // Use filtered deliveries for export
            const exportDeliveries = getFilteredDeliveries();
            const totalDiesel = exportDeliveries.reduce((s, d) => s + (parseFloat(d.gallons) || 0), 0);
            const totalDef = exportDeliveries.reduce((s, d) => s + (parseFloat(d.def_gallons) || 0), 0);
            const dateFilter = document.getElementById('deliveryDateFilter')?.value;

            // ‚îÄ‚îÄ Sheet 1: Summary ‚îÄ‚îÄ
            const summary = [
                ['', '', siteName],
                [],
                ['Site Information'],
                ['Address', addr],
                ['Customer', first.customer_name || ''],
                ['Contact', first.contact_name || ''],
                ['Phone', first.contact_phone || ''],
                ['Contract #', first.contract_number || ''],
                ['PO #', first.po_number || ''],
                [],
                ['Fuel Summary' + (dateFilter ? ` (${new Date(dateFilter+'T00:00').toLocaleDateString()})` : ' (All Time)')],
                ['Total Deliveries', exportDeliveries.length],
                ['Total Diesel (gal)', totalDiesel],
                ['Total DEF (gal)', totalDef],
                ['Total Equipment Units', siteEquip.length],
                [],
                ['Report Generated', new Date().toLocaleString()],
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summary);
            ws1['!cols'] = [{ wch: 22 }, { wch: 45 }, { wch: 30 }];
            XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

            // ‚îÄ‚îÄ Sheet 2: Equipment ‚îÄ‚îÄ
            if (siteEquip.length) {
                const eqData = [['Unit #', 'Description', 'QTY']];
                siteEquip.forEach(e => {
                    eqData.push([e.equipment_number || '‚Äî', e.description || '', e.quantity || 1]);
                });
                const ws2 = XLSX.utils.aoa_to_sheet(eqData);
                ws2['!cols'] = [{ wch: 16 }, { wch: 35 }, { wch: 8 }];
                XLSX.utils.book_append_sheet(wb, ws2, 'Equipment');
            }

            // ‚îÄ‚îÄ Sheet 3: Delivery History ‚îÄ‚îÄ
            if (exportDeliveries.length) {
                const delData = [['Date', 'Time', 'Driver', 'Unit #', 'Diesel (gal)', 'DEF (gal)', 'Gen Hours', 'Notes']];
                exportDeliveries.forEach(d => {
                    const dt = d.timestamp ? new Date(d.timestamp) : null;
                    delData.push([
                        dt ? dt.toLocaleDateString() : '',
                        dt ? dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
                        d.delivered_by_name || '',
                        d.unit_number || '',
                        parseFloat(d.gallons) || 0,
                        parseFloat(d.def_gallons) || 0,
                        d.unit_hours || '',
                        d.notes || ''
                    ]);
                });
                // Totals row
                delData.push([]);
                delData.push(['', '', '', 'TOTALS', totalDiesel, totalDef, '', '']);

                const ws3 = XLSX.utils.aoa_to_sheet(delData);
                ws3['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 18 }, { wch: 14 }, { wch: 14 }, { wch: 12 }, { wch: 12 }, { wch: 30 }];
                XLSX.utils.book_append_sheet(wb, ws3, 'Delivery History');
            }

            const filename = siteName.replace(/[^a-zA-Z0-9]/g, '_') + '_report.xlsx';
            XLSX.writeFile(wb, filename);
        }

        function esc(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    </script>
</body>
</html>
