<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush ‚Äî Job Site Detail</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .back-link { display:inline-flex; align-items:center; gap:6px; font-size:14px; color:var(--text-secondary); margin-bottom:16px; }
        .back-link:hover { color:var(--primary); }
        .site-header-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:24px; margin-bottom:24px; }
        .site-title { font-size:24px; font-weight:700; margin-bottom:4px; }
        .site-address { font-size:14px; color:var(--text-secondary); }
        .timeline { margin-top:8px; }
        .timeline-item {
            display:flex; gap:16px; padding:16px 0; border-bottom:1px solid var(--border-light);
            position:relative;
        }
        .timeline-item:last-child { border-bottom:none; }
        .timeline-date {
            min-width:100px; font-size:13px; color:var(--text-muted); font-weight:600; padding-top:2px;
        }
        .timeline-content { flex:1; }
        .timeline-type { font-size:14px; font-weight:600; color:var(--text-primary); text-transform:capitalize; margin-bottom:4px; }
        .timeline-details { font-size:13px; color:var(--text-secondary); line-height:1.6; }
        .timeline-details span { display:inline-block; margin-right:16px; }
        .fuel-tag { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:600; }
        .fuel-tag.diesel { background:var(--warning-light); color:var(--warning); }
        .fuel-tag.def { background:var(--primary-light); color:var(--primary); }
        .equip-list { margin-top:8px; }
        .equip-item { font-size:12px; color:var(--text-muted); padding:2px 0; }
        .filter-row { display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; align-items:center; }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo">‚õΩ</div>
                <span class="brand-name">GasRush</span>
            </div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="flex justify-between items-center" style="margin-bottom:16px">
                <a href="job-sites.html" class="back-link" style="margin:0">‚Üê Back to Job Sites</a>
                <button class="btn btn-primary" onclick="exportExcel()">üì• Export to Excel</button>
            </div>

            <div class="site-header-card" id="siteHeader">
                <div class="empty-state"><h3>Loading...</h3></div>
            </div>

            <div class="stats-grid" id="siteStats"></div>

            <!-- Job History -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Job History</h2>
                </div>
                <div class="filter-row">
                    <select class="form-select" id="statusFilter" style="width:160px" onchange="renderJobs()">
                        <option value="">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="active">Active</option>
                        <option value="pending">Pending</option>
                    </select>
                    <select class="form-select" id="typeFilter" style="width:160px" onchange="renderJobs()">
                        <option value="">All Types</option>
                        <option value="fuel-delivery">Fuel Delivery</option>
                        <option value="service">Service</option>
                        <option value="swap">Swap</option>
                    </select>
                </div>
                <div id="jobHistory"></div>
            </div>

            <!-- Equipment at this site -->
            <div class="card mt-4" id="equipSection" style="display:none">
                <div class="card-header">
                    <h2 class="card-title">Equipment at this Site</h2>
                </div>
                <div id="equipList"></div>
            </div>
        </main>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let allJobs = [];
        let siteEquip = [];
        const siteName = new URLSearchParams(window.location.search).get('site');

        (async () => {
            const user = await GasRush.init({ roles: ['rental', 'vendor', 'fieldworker', 'admin'] });
            if (!user) return;
            if (!siteName) { window.location.href = 'job-sites.html'; return; }
            document.title = `GasRush ‚Äî ${siteName}`;
            await loadData();
        })();

        async function loadData() {
            try {
                const { data: jobs, error } = await GasRush.db()
                    .from('jobs')
                    .select('*')
                    .eq('job_site_name', siteName)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                allJobs = jobs || [];

                // Load equipment for all job IDs at this site
                const jobIds = allJobs.map(j => j.id);
                if (jobIds.length) {
                    const { data: equip } = await GasRush.db()
                        .from('equipment')
                        .select('*')
                        .in('job_id', jobIds);
                    siteEquip = equip || [];
                }

                renderHeader();
                renderStats();
                renderJobs();
                renderEquipment();
            } catch(e) {
                console.error(e);
                document.getElementById('siteHeader').innerHTML = '<div class="empty-state"><h3>Failed to load site data</h3></div>';
            }
        }

        function renderHeader() {
            const first = allJobs[0] || {};
            const addr = [first.address_street, first.address_city, first.address_state, first.address_zip].filter(Boolean).join(', ');
            document.getElementById('siteHeader').innerHTML = `
                <div class="site-title">${esc(siteName)}</div>
                <div class="site-address">üìç ${esc(addr || 'No address on file')}</div>
                ${first.customer_name ? `<div style="font-size:14px;color:var(--text-secondary);margin-top:4px">Customer: <strong>${esc(first.customer_name)}</strong></div>` : ''}
                ${first.contact_name ? `<div style="font-size:13px;color:var(--text-muted)">Contact: ${esc(first.contact_name)} ${esc(first.contact_phone || '')}</div>` : ''}
            `;
        }

        function renderStats() {
            const total = allJobs.length;
            const completed = allJobs.filter(j => j.status === 'completed').length;
            const fuel = allJobs.reduce((s, j) => s + (parseFloat(j.billable_services?.fuelGallons) || 0), 0);
            const def = allJobs.reduce((s, j) => s + (parseFloat(j.billable_services?.defGallons) || 0), 0);
            const firstDate = allJobs.length ? new Date(allJobs[allJobs.length - 1].created_at).toLocaleDateString() : '‚Äî';
            const lastDate = allJobs.length ? new Date(allJobs[0].created_at).toLocaleDateString() : '‚Äî';

            document.getElementById('siteStats').innerHTML = `
                <div class="stat-card"><div class="stat-label">Total Jobs</div><div class="stat-value">${total}</div></div>
                <div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value">${completed}</div></div>
                <div class="stat-card"><div class="stat-label">Total Fuel</div><div class="stat-value">${fuel.toLocaleString()}</div><div class="stat-sub">gallons diesel</div></div>
                <div class="stat-card"><div class="stat-label">Total DEF</div><div class="stat-value">${def.toLocaleString()}</div><div class="stat-sub">gallons</div></div>
                <div class="stat-card"><div class="stat-label">First Job</div><div class="stat-value" style="font-size:16px">${firstDate}</div></div>
                <div class="stat-card"><div class="stat-label">Latest Job</div><div class="stat-value" style="font-size:16px">${lastDate}</div></div>
            `;
        }

        function renderJobs() {
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;
            let filtered = allJobs;

            if (status) {
                if (status === 'active') filtered = filtered.filter(j => ['active', 'assigned', 'in-progress', 'accepted'].includes(j.status));
                else if (status === 'pending') filtered = filtered.filter(j => ['pending', 'created'].includes(j.status));
                else filtered = filtered.filter(j => j.status === status);
            }
            if (type) filtered = filtered.filter(j => j.job_type === type);

            const container = document.getElementById('jobHistory');
            if (!filtered.length) {
                container.innerHTML = '<div class="empty-state" style="padding:32px"><h3>No jobs match filters</h3></div>';
                return;
            }

            container.innerHTML = '<div class="timeline">' + filtered.map(j => {
                const date = j.created_at ? new Date(j.created_at).toLocaleDateString() : '‚Äî';
                const fuel = parseFloat(j.billable_services?.fuelGallons) || 0;
                const def = parseFloat(j.billable_services?.defGallons) || 0;
                const status = j.status || 'pending';
                const bc = status === 'completed' ? 'badge-success' : ['active', 'assigned', 'in-progress', 'accepted'].includes(status) ? 'badge-primary' : status === 'cancelled' ? 'badge-danger' : 'badge-warning';
                const jobEquip = siteEquip.filter(e => e.job_id === j.id);

                return `<div class="timeline-item">
                    <div class="timeline-date">${date}</div>
                    <div class="timeline-content">
                        <div class="timeline-type">${(j.job_type || 'delivery').replace('-', ' ')} <span class="badge ${bc}" style="font-size:11px;vertical-align:middle">${status}</span></div>
                        <div class="timeline-details">
                            ${j.contract_number ? `<span>Contract: <strong>${esc(j.contract_number)}</strong></span>` : ''}
                            ${j.po_number ? `<span>PO: <strong>${esc(j.po_number)}</strong></span>` : ''}
                            ${fuel > 0 ? `<span class="fuel-tag diesel">‚õΩ ${fuel.toLocaleString()} gal diesel</span>` : ''}
                            ${def > 0 ? `<span class="fuel-tag def">üíß ${def.toLocaleString()} gal DEF</span>` : ''}
                            ${j.field_ticket_id ? `<span>Ticket: ${esc(j.field_ticket_id)}</span>` : ''}
                            ${j.work_performed ? `<div style="margin-top:4px;font-style:italic">${esc(j.work_performed)}</div>` : ''}
                        </div>
                        ${jobEquip.length ? `<div class="equip-list">${jobEquip.map(e =>
                            `<div class="equip-item">üîß ${e.quantity || 1}x ${esc(e.equipment_number || '')} ‚Äî ${esc(e.description || '')}</div>`
                        ).join('')}</div>` : ''}
                    </div>
                </div>`;
            }).join('') + '</div>';
        }

        function renderEquipment() {
            if (!siteEquip.length) return;
            document.getElementById('equipSection').style.display = '';

            // Deduplicate by equipment_number
            const unique = {};
            for (const e of siteEquip) {
                const key = e.equipment_number || e.description || e.id;
                if (!unique[key]) unique[key] = { ...e, count: 0 };
                unique[key].count++;
            }

            document.getElementById('equipList').innerHTML = '<div class="table-wrapper"><table><thead><tr><th>Unit #</th><th>Description</th><th>Times Serviced</th></tr></thead><tbody>' +
                Object.values(unique).map(e => `<tr>
                    <td><strong>${esc(e.equipment_number || '‚Äî')}</strong></td>
                    <td>${esc(e.description || '‚Äî')}</td>
                    <td>${e.count}</td>
                </tr>`).join('') + '</tbody></table></div>';
        }

        function exportExcel() {
            if (!allJobs.length) { alert('No data to export'); return; }

            // Summary sheet
            const totalFuel = allJobs.reduce((s, j) => s + (parseFloat(j.billable_services?.fuelGallons) || 0), 0);
            const totalDef = allJobs.reduce((s, j) => s + (parseFloat(j.billable_services?.defGallons) || 0), 0);
            const completed = allJobs.filter(j => j.status === 'completed').length;
            const first = allJobs[allJobs.length - 1];

            const summary = [
                ['Job Site Summary'],
                ['Site Name', siteName],
                ['Address', [first.address_street, first.address_city, first.address_state, first.address_zip].filter(Boolean).join(', ')],
                ['Customer', first.customer_name || ''],
                ['Contact', first.contact_name || '', first.contact_phone || ''],
                [],
                ['Total Jobs', allJobs.length],
                ['Completed', completed],
                ['Total Diesel (gal)', totalFuel],
                ['Total DEF (gal)', totalDef],
                ['Date Range', allJobs.length ? new Date(allJobs[allJobs.length-1].created_at).toLocaleDateString() + ' ‚Äî ' + new Date(allJobs[0].created_at).toLocaleDateString() : ''],
            ];

            // Job detail rows
            const headers = ['Date', 'Type', 'Status', 'Contract #', 'PO #', 'Diesel (gal)', 'DEF (gal)', 'Field Ticket', 'Work Performed', 'Notes'];
            const rows = allJobs.map(j => [
                j.created_at ? new Date(j.created_at).toLocaleDateString() : '',
                (j.job_type || '').replace('-', ' '),
                j.status || '',
                j.contract_number || '',
                j.po_number || '',
                parseFloat(j.billable_services?.fuelGallons) || '',
                parseFloat(j.billable_services?.defGallons) || '',
                j.field_ticket_id || '',
                j.work_performed || '',
                j.instructions || ''
            ]);

            // Equipment rows
            const equipHeaders = ['Unit #', 'Description', 'Qty', 'Job Date', 'Contract #'];
            const equipRows = siteEquip.map(e => {
                const job = allJobs.find(j => j.id === e.job_id);
                return [
                    e.equipment_number || '',
                    e.description || '',
                    e.quantity || 1,
                    job?.created_at ? new Date(job.created_at).toLocaleDateString() : '',
                    job?.contract_number || ''
                ];
            });

            // Build workbook
            const wb = XLSX.utils.book_new();

            const ws1 = XLSX.utils.aoa_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

            const ws2 = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            ws2['!cols'] = headers.map(() => ({ wch: 16 }));
            XLSX.utils.book_append_sheet(wb, ws2, 'Job History');

            if (equipRows.length) {
                const ws3 = XLSX.utils.aoa_to_sheet([equipHeaders, ...equipRows]);
                XLSX.utils.book_append_sheet(wb, ws3, 'Equipment');
            }

            const filename = siteName.replace(/[^a-zA-Z0-9]/g, '_') + '_report.xlsx';
            XLSX.writeFile(wb, filename);
        }

        function esc(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    </script>
</body>
</html>
