<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasRush — Review Deliveries</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .rate-input {
            width: 90px; padding: 8px; font-size: 14px; text-align: right;
            background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px;
            color: var(--text-primary);
        }
        .rate-input:focus { border-color: var(--primary); outline: none; }
        .confirm-btn {
            padding: 8px 16px; font-size: 13px; font-weight: 600;
            background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;
        }
        .confirm-btn:hover { opacity: 0.9; }
        .confirm-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .bulk-bar {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
        }
        .bulk-bar label { font-size: 13px; color: var(--text-secondary); font-weight: 600; }
        .empty-msg { padding: 48px; text-align: center; color: var(--text-muted); }
        .delivery-card { background:var(--bg-secondary); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:12px; }
        .delivery-card .dc-header { display:flex; justify-content:space-between; margin-bottom:12px; }
        .delivery-card .dc-site { font-weight:600; font-size:15px; color:var(--text-primary); }
        .delivery-card .dc-date { font-size:12px; color:var(--text-muted); }
        .delivery-card .dc-details { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:12px; font-size:13px; }
        .delivery-card .dc-label { color:var(--text-muted); font-size:11px; text-transform:uppercase; font-weight:600; }
        .delivery-card .dc-value { color:var(--text-primary); font-weight:600; }
        .delivery-card .dc-rates { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px; }
        .delivery-card .dc-rates label { font-size:12px; color:var(--text-muted); }
        @media(max-width:768px) {
            .bulk-bar { flex-direction:column; align-items:stretch; }
            .bulk-bar > div { display:flex; justify-content:space-between; align-items:center; }
            .rate-input { width:100px; }
            .delivery-card .dc-details { grid-template-columns:1fr 1fr; }
        }
        .status-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
        }
        .status-badge.pending { background: var(--warning-light); color: var(--warning); }
        .status-badge.confirmed { background: var(--success-light, #d4edda); color: var(--success, #28a745); }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand"><div class="logo">⛽</div><span class="brand-name">GasRush</span></div>
            <nav id="sidebarNav"></nav>
            <div id="sidebarFooter"></div>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>Review Deliveries</h1>
                <p>Confirm pending deliveries and set rates</p>
            </div>

            <div class="bulk-bar" id="bulkBar" style="display:none">
                <label>Apply to all:</label>
                <div style="display:flex;align-items:center;gap:4px">
                    <span style="font-size:13px;color:var(--text-muted)">Diesel $/gal</span>
                    <input type="number" id="bulkDieselRate" class="rate-input" step="0.01" min="0" placeholder="0.00">
                </div>
                <div style="display:flex;align-items:center;gap:4px">
                    <span style="font-size:13px;color:var(--text-muted)">DEF $/gal</span>
                    <input type="number" id="bulkDefRate" class="rate-input" step="0.01" min="0" placeholder="0.00">
                </div>
                <div style="display:flex;align-items:center;gap:4px">
                    <span style="font-size:13px;color:var(--text-muted)">Delivery Fee $</span>
                    <input type="number" id="bulkDeliveryFee" class="rate-input" step="0.01" min="0" placeholder="0.00">
                </div>
                <button class="confirm-btn" onclick="confirmAll()">Confirm All</button>
            </div>

            <div class="card">
                <div id="deliveryList">
                    <div class="empty-msg">Loading...</div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script src="mobile.js"></script>
    <script>
        let currentUser = null;
        let pendingDeliveries = [];
        let jobMap = {};

        (async () => {
            const user = await GasRush.init({ roles: ['vendor'] });
            if (!user) return;
            currentUser = user;
            await loadPending();
        })();

        async function loadPending() {
            try {
                // Get jobs assigned to this vendor
                const { data: jobs, error: jobErr } = await GasRush.db()
                    .from('jobs')
                    .select('*')
                    .eq('assigned_vendor', currentUser.vendor_id);
                if (jobErr) throw jobErr;
                if (!jobs || !jobs.length) {
                    document.getElementById('deliveryList').innerHTML = '<div class="empty-msg">No jobs assigned to your company</div>';
                    return;
                }

                jobMap = {};
                jobs.forEach(j => { jobMap[j.id] = j; });
                const jobIds = jobs.map(j => j.id);

                // Get pending deliveries for those jobs
                const { data: dels, error: delErr } = await GasRush.db()
                    .from('deliveries')
                    .select('*')
                    .in('job_id', jobIds)
                    .eq('status', 'pending')
                    .order('timestamp', { ascending: false });
                if (delErr) throw delErr;

                pendingDeliveries = dels || [];
                render();
            } catch(e) {
                console.error(e);
                document.getElementById('deliveryList').innerHTML = '<div class="empty-msg">Failed to load deliveries</div>';
            }
        }

        function render() {
            const list = document.getElementById('deliveryList');
            if (!pendingDeliveries.length) {
                list.innerHTML = '<div class="empty-msg">No pending deliveries to review</div>';
                document.getElementById('bulkBar').style.display = 'none';
                return;
            }

            document.getElementById('bulkBar').style.display = '';

            let h = '';
            pendingDeliveries.forEach((d, i) => {
                const job = jobMap[d.job_id] || {};
                const date = d.timestamp ? new Date(d.timestamp).toLocaleString([], { month:'numeric', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit' }) : '—';
                h += `<div class="delivery-card" id="row-${d.id}">
                    <div class="dc-header">
                        <div class="dc-site">${esc(job.job_site_name || '—')}</div>
                        <div class="dc-date">${date}</div>
                    </div>
                    <div class="dc-details">
                        <div><div class="dc-label">Unit #</div><div class="dc-value">${esc(d.unit_number || '—')}</div></div>
                        <div><div class="dc-label">Driver</div><div class="dc-value">${esc(d.delivered_by_name || '—')}</div></div>
                        <div><div class="dc-label">Gen Hours</div><div class="dc-value">${d.unit_hours || '—'}</div></div>
                        <div><div class="dc-label">Diesel</div><div class="dc-value">${d.gallons || 0} gal</div></div>
                        <div><div class="dc-label">DEF</div><div class="dc-value">${d.def_gallons || 0} gal</div></div>
                    </div>
                    <div class="dc-rates">
                        <div><label>Diesel $/gal</label><br><input type="number" class="rate-input diesel-rate" data-id="${d.id}" step="0.01" min="0" placeholder="0.00"></div>
                        <div><label>DEF $/gal</label><br><input type="number" class="rate-input def-rate" data-id="${d.id}" step="0.01" min="0" placeholder="0.00"></div>
                        <div><label>Delivery Fee</label><br><input type="number" class="rate-input del-fee" data-id="${d.id}" step="0.01" min="0" placeholder="0.00"></div>
                        <button class="confirm-btn" style="align-self:flex-end" onclick="confirmOne('${d.id}')">Confirm</button>
                    </div>
                </div>`;
            });

            list.innerHTML = h;
        }

        function getRowRates(id) {
            const dr = parseFloat(document.querySelector(`.diesel-rate[data-id="${id}"]`)?.value) || 0;
            const defr = parseFloat(document.querySelector(`.def-rate[data-id="${id}"]`)?.value) || 0;
            const fee = parseFloat(document.querySelector(`.del-fee[data-id="${id}"]`)?.value) || 0;
            return { diesel_rate: dr, def_rate: defr, delivery_fee: fee };
        }

        async function confirmOne(id) {
            const d = pendingDeliveries.find(x => x.id === id);
            if (!d) return;

            const rates = getRowRates(id);
            const total = ((parseFloat(d.gallons) || 0) * rates.diesel_rate) +
                          ((parseFloat(d.def_gallons) || 0) * rates.def_rate) +
                          rates.delivery_fee;

            const btn = document.querySelector(`#row-${id} .confirm-btn`);
            if (btn) { btn.disabled = true; btn.textContent = '...'; }

            try {
                const { error } = await GasRush.db().from('deliveries').update({
                    diesel_rate: rates.diesel_rate,
                    def_rate: rates.def_rate,
                    delivery_fee: rates.delivery_fee,
                    total: Math.round(total * 100) / 100,
                    status: 'confirmed',
                    confirmed_by: currentUser.id,
                    confirmed_at: new Date().toISOString()
                }).eq('id', id);
                if (error) throw error;

                // Create invoice with rates
                const job = jobMap[d.job_id] || {};
                const roundedTotal = Math.round(total * 100) / 100;
                await GasRush.db().from('invoices').insert({
                    job_id: d.job_id,
                    worker_id: d.delivered_by || null,
                    worker_name: d.delivered_by_name || '',
                    invoice_date: new Date().toISOString().split('T')[0],
                    invoice_time: new Date().toTimeString().split(' ')[0],
                    total_diesel: parseFloat(d.gallons) || 0,
                    total_def: parseFloat(d.def_gallons) || 0,
                    units_data: JSON.stringify([{
                        unit_number: d.unit_number,
                        diesel: parseFloat(d.gallons) || 0,
                        def: parseFloat(d.def_gallons) || 0,
                        gen_hours: d.unit_hours || null,
                        diesel_rate: rates.diesel_rate,
                        def_rate: rates.def_rate,
                        delivery_fee: rates.delivery_fee,
                        total: roundedTotal
                    }]),
                    notes: `Confirmed by ${currentUser.name}. Site: ${job.job_site_name || ''}`
                });

                await logAudit(d.job_id, 'delivery_confirmed', {
                    delivery_id: id, diesel_rate: rates.diesel_rate, def_rate: rates.def_rate,
                    delivery_fee: rates.delivery_fee, total: roundedTotal
                });

                pendingDeliveries = pendingDeliveries.filter(x => x.id !== id);
                render();
            } catch(e) {
                alert('Failed to confirm: ' + (e.message || e));
                if (btn) { btn.disabled = false; btn.textContent = 'Confirm'; }
            }
        }

        async function confirmAll() {
            const dr = parseFloat(document.getElementById('bulkDieselRate').value) || 0;
            const defr = parseFloat(document.getElementById('bulkDefRate').value) || 0;
            const fee = parseFloat(document.getElementById('bulkDeliveryFee').value) || 0;

            if (!dr && !defr && !fee) {
                alert('Please enter at least one rate in the bulk bar.');
                return;
            }

            if (!confirm(`Confirm all ${pendingDeliveries.length} deliveries with Diesel: $${dr}/gal, DEF: $${defr}/gal, Fee: $${fee}?`)) return;

            const toConfirm = [...pendingDeliveries];
            let success = 0;
            for (const d of toConfirm) {
                const total = ((parseFloat(d.gallons) || 0) * dr) +
                              ((parseFloat(d.def_gallons) || 0) * defr) + fee;
                try {
                    const { error } = await GasRush.db().from('deliveries').update({
                        diesel_rate: dr, def_rate: defr, delivery_fee: fee,
                        total: Math.round(total * 100) / 100,
                        status: 'confirmed',
                        confirmed_by: currentUser.id,
                        confirmed_at: new Date().toISOString()
                    }).eq('id', d.id);
                    if (!error) {
                        success++;
                        await logAudit(d.job_id, 'delivery_confirmed', {
                            delivery_id: d.id, diesel_rate: dr, def_rate: defr,
                            delivery_fee: fee, total: Math.round(total * 100) / 100, bulk: true
                        });
                    }
                } catch(e) { console.error('Failed:', d.id, e); }
            }

            alert(`Confirmed ${success} of ${toConfirm.length} deliveries.`);
            pendingDeliveries = pendingDeliveries.filter(d => !toConfirm.find(t => t.id === d.id));
            await loadPending();
        }

        async function logAudit(jobId, action, details) {
            try {
                await GasRush.db().from('audit_logs').insert({
                    user_id: currentUser.id?.length === 36 ? currentUser.id : null,
                    user_name: currentUser.name || currentUser.email,
                    action, target_type: 'delivery', target_id: jobId, details
                });
            } catch(e) { console.warn('Audit log failed:', e); }
        }

        function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    </script>
</body>
</html>
